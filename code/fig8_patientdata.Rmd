---
title: "Figure 8 - reanalyzed"
author: "Kate"
date: "2024-08-27"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(here)
library(tidyverse)
library(janitor)
library(readxl)
library(cBioPortalData)
library(MetaIntegrator)
library(cbioportalR)
library(pheatmap)
library(cowplot)
library(ggpubr)
library(survival)
library(survminer)
library(GSVA)
library(GSEABase)
library(matrixStats)
library(clusterProfiler)
library(msigdbr)
```

# Load RNA signatures - generated in fig 6 code

### 3e normoxia and hypoxia
```{r}


rna_3e_norm <- read_excel(here("counts/rna_signature_3e_normoxia.xlsx")) %>% 
  filter(padj < 0.05)

up_3e_norm <- rna_3e_norm %>% 
  filter(log2FoldChange > 1)
  
tally(up_3e_norm)

down_3e_norm <- rna_3e_norm %>% 
  filter(log2FoldChange < -1)
  
tally(down_3e_norm)

sig_3e_norm <- rbind(up_3e_norm, down_3e_norm)

# 3e hypoxia

rna_3e_hyp <- read_excel(here("counts/rna_signature_3e_hypoxia.xlsx")) %>% 
  filter(padj < 0.05)

up_3e_hyp <- rna_3e_hyp %>% 
  filter(log2FoldChange > 1)
  
tally(up_3e_hyp)

down_3e_hyp <- rna_3e_hyp %>% 
  filter(log2FoldChange < -1)
  
tally(down_3e_hyp)

sig_3e_hyp <- rbind(up_3e_hyp, down_3e_hyp)


```


### 3d normoxia and hypoxia
```{r}


rna_3d_norm <- read_excel(here("counts/rna_signature_3d_normoxia.xlsx")) %>% 
  filter(padj < 0.05)

up_3d_norm <- rna_3d_norm %>% 
  filter(log2FoldChange > 1)
  
tally(up_3d_norm)

down_3d_norm <- rna_3d_norm %>% 
  filter(log2FoldChange < -1)
  
tally(down_3d_norm)

sig_3d_norm <- rbind(up_3d_norm, down_3d_norm)


# 3d hypoxia

rna_3d_hyp <- read_excel(here("counts/rna_signature_3d_hypoxia.xlsx")) %>% 
  filter(padj < 0.05)

up_3d_hyp <- rna_3d_hyp %>% 
  filter(log2FoldChange > 1)
  
tally(up_3d_hyp)

down_3d_hyp <- rna_3d_hyp %>% 
  filter(log2FoldChange < -1)
  
tally(down_3d_hyp)

sig_3d_hyp <- rbind(up_3d_hyp, down_3d_hyp)


```




### a209 normoxia and hypoxia
```{r}

rna_a209_norm <- read_excel(here("counts/rna_signature_a209_normoxia.xlsx")) %>% 
  filter(padj < 0.05)

up_a209_norm <- rna_a209_norm %>% 
  filter(log2FoldChange > 1)
  
tally(up_a209_norm)

down_a209_norm <- rna_a209_norm %>% 
  filter(log2FoldChange < -1)
  
tally(down_a209_norm)

sig_a209_norm <- rbind(up_a209_norm, down_a209_norm)


# a209 hypoxia

rna_a209_hyp <- read_excel(here("counts/rna_signature_a209_hypoxia.xlsx")) %>% 
  filter(padj < 0.05)

up_a209_hyp <- rna_a209_hyp %>% 
  filter(log2FoldChange > 1)
  
tally(up_a209_hyp)

down_a209_hyp <- rna_a209_hyp %>% 
  filter(log2FoldChange < -1)
  
tally(down_a209_hyp)

sig_a209_hyp <- rbind(up_a209_hyp, down_a209_hyp)


```




# Import Metabric data - read patient z scores and matching clinical data
```{r cache = TRUE}
zscores <- read.table(here("cbioportal_data/data_mrna_illumina_microarray_zscores_ref_diploid_samples.txt"), sep="\t", header=T)
row.names(zscores) <- gsub("_", ".",row.names(zscores))

# there are duplicates in this list. What happens when i subset for the genes we are interested in?

zscores_all_symbol <- zscores %>% 
  dplyr::select(-Entrez_Gene_Id)

### Average scores for duplicate patients

merged_zscores_all <- zscores_all_symbol %>%
  group_by(Hugo_Symbol) %>%
  summarise(across(everything(), mean))


merged_zscores_matrix <- merged_zscores_all %>% 
  column_to_rownames("Hugo_Symbol") %>% 
  as.matrix()


```


# Assign to each patient a z score for the 3e normoxia signature

Filter expression matrix for genes of interest
```{r}
# genes <- sig_3e_norm$symbol
# 
# verified_genes <- genes[genes %in% rownames(merged_zscores_matrix)]
# 
# filtered_expr <- merged_zscores_matrix[verified_genes, , drop = FALSE]


```



for loop generating z score for each patient

1. Create expression data
```{r}

exp <- merged_zscores_matrix %>%
  as.data.frame() %>% 
  rownames_to_column("Hugo_Symbol") %>% 
    filter(Hugo_Symbol %in% sig_3e_norm$symbol) %>% 
 column_to_rownames("Hugo_Symbol")


```



Assign a z score for each patient for 3e norm up values
#up values
```{r}
patients <- colnames(merged_zscores_all)
patients <- patients[patients !="Hugo_Symbol"]

up_3e_norm_dataset <- data.frame(patient=character(), avg_z_score=numeric(), stringsAsFactors = FALSE)

for (i in patients) {

  #filter dataframe
  patient_level <- exp %>% 
    dplyr::select(i) %>%
    rownames_to_column("Hugo_Symbol") %>% 
    filter(Hugo_Symbol %in% up_3e_norm$symbol)

    all_values <- as.vector(patient_level[,2])
  
  
  #geometric mean
  
  up_genes_z_score <- mean(all_values)

  loop_dataset <- data.frame(patient=i, norm_3e_z_score_up = up_genes_z_score)
  
  up_3e_norm_dataset <- rbind(up_3e_norm_dataset, loop_dataset)
}

ggplot(up_3e_norm_dataset, aes(x=norm_3e_z_score_up))+
  geom_histogram(bins = 400)

```
Plot distribution of values

#down values
```{r}

patients <- colnames(merged_zscores_all)
patients <- patients[patients !="Hugo_Symbol"]


down_3e_norm_dataset <- data.frame(patient=character(), avg_z_score=numeric(), stringsAsFactors = FALSE)

for (i in patients) {

  #filter dataframe
  patient_level <- exp %>% 
    dplyr::select(i) %>%
    rownames_to_column("Hugo_Symbol") %>% 
    filter(Hugo_Symbol %in% down_3e_norm$symbol)

    all_values <- as.vector(patient_level[,2])
  
  
  #geometric mean
  
  down_genes_z_score <- mean(all_values)

  loop_dataset <- data.frame(patient=i, norm_3e_z_score_down = down_genes_z_score)
  
  down_3e_norm_dataset <- rbind(down_3e_norm_dataset, loop_dataset)
}

ggplot(down_3e_norm_dataset, aes(x=norm_3e_z_score_down))+
  geom_histogram(bins = 400)


```


Merge up and down z score and create a total z score value per patient
```{r}
patient_scores <- left_join(up_3e_norm_dataset, down_3e_norm_dataset, by="patient")

patient_scores <- patient_scores %>% 
  mutate(total_z_score = norm_3e_z_score_up - norm_3e_z_score_down)

```

Visualize total z scores
```{r}
ggplot(patient_scores, aes(x=total_z_score))+
  geom_histogram(bins = 400)
```


Stratify patients into quartiles for 3e norm signature based on z score

```{r}
quantile_groups <- quantile(patient_scores$total_z_score, probs=seq(0,1,.25), na.rm=TRUE)

patient_scores$quantile <- cut(patient_scores$total_z_score, breaks = quantile_groups, include.lowest = TRUE, labels = FALSE)

patient_scores$patient <- sub("-[^-]*$", "", patient_scores$patient)

```

### Read in patient meta data
Clinical data contains surival data
```{r}

clin <- read.table(here("cbioportal_data/data_clinical_patient.txt"), sep="\t", header=T)


clin$OS_STATUS[which(clin$OS_STATUS == "1:DECEASED" & clin$OS_MONTHS > 120)] <- "0:LIVING"
clin$OS_STATUS <- clin$OS_STATUS == "1:DECEASED"
clin <- cbind(clin, OS_YEARS = clin$OS_MONTHS/12)
clin$OS_YEARS[which(clin$OS_YEARS >= 10)] <- 10
dim(clin)


```

Bind clin data with patient z score data
```{r}

patient_scores$patient <- gsub("\\.", "-", patient_scores$patient)

all_data <- left_join(clin, patient_scores, by=c("PATIENT_ID"="patient"))
clin$PATIENT_ID
patient_scores$patient

# all_data <- all_data %>% 
#   mutate(high_signature = ifelse(quantile==4, TRUE, FALSE))
# 
# all_data <- all_data %>% 
#   mutate(low_signature = ifelse(quantile==1, TRUE, FALSE))
# 
# all_data <- all_data %>% 
#   mutate(medium_low_signature = ifelse(quantile==2, TRUE, FALSE))
# 
# all_data <- all_data %>% 
#   mutate(medium_high_signature = ifelse(quantile==3, TRUE, FALSE))
```

## eif3e signature vs survival
Visualize survival data by 3e normoxia signature expression

```{r}
fit_all <- survfit(Surv(OS_YEARS, OS_STATUS) ~ quantile, data = all_data)

coxfit <- coxph(Surv(OS_YEARS, OS_STATUS) ~ quantile, all_data)
summary(coxfit)

str(survfit(coxfit))

#report hazards ratio on plot

summary_coxfit <- summary(coxfit)

hr <- round(summary_coxfit$coefficients[1, "exp(coef)"], 2)
pval <- format.pval(summary_coxfit$coefficients[1, "Pr(>|z|)"], digits = 2, eps = 0.001)

```

```{r}

surv_plot <- ggsurvplot(fit_all, data = all_data, size = 1, palette = c("#E7B800", "pink", "purple", "#2E9FDF"),legend.labs = c("depleted for eIF3e signature: low (Q1)","depleted: medium-low (Q2)", "enriched: medium-high (Q3)", "enriched for eIF3e signature: high (Q4)"),  break.time.by = 1, ylab="Overall Survival", xlab = "Time in years", xlim = c(0,10),conf.int = TRUE, pval = FALSE, risk.table = FALSE,  risk.table.col = "strata", risk.table.height = 0.25, ggtheme = theme_bw())



surv_plot$plot <- surv_plot$plot + 
  annotate(
    "text", 
    x = 3, y = 0.2, 
    label = paste("HR =", hr, "\np =", pval), 
    size = 5, 
    color = "black"
  )+
  theme(text = element_text(size = 14))

surv_plot

ggsave("3e_normoxia_surv_plot.pdf", path=here("plots"),width = 11.5, height=8)
```

Plot just upper and lower quartiles

# eIF3e Hypoxia signature with survival

```{r}
# For loop generating z score for each patient

#expression matrix changes based on signature

exp <- merged_zscores_matrix %>%
  as.data.frame() %>% 
  rownames_to_column("Hugo_Symbol") %>% 
  filter(Hugo_Symbol %in% sig_3e_hyp$symbol) %>% 
  column_to_rownames("Hugo_Symbol")

# up loop
patients <- colnames(merged_zscores_all)
patients <- patients[patients !="Hugo_Symbol"]


up_3e_hyp_dataset <- data.frame(patient=character(), avg_z_score=numeric(), stringsAsFactors = FALSE)

for (i in patients) {
  
  #filter dataframe
  patient_level <- exp %>% 
    dplyr::select(i) %>%
    rownames_to_column("Hugo_Symbol") %>% 
    filter(Hugo_Symbol %in% up_3e_hyp$symbol)
  
  all_values <- as.vector(patient_level[,2])
  
  
  #geometric mean
  
  up_genes_z_score <- mean(all_values, na.rm=TRUE)
  
  loop_dataset <- data.frame(patient=i, hyp_3e_z_score_up = up_genes_z_score)
  
  up_3e_hyp_dataset <- rbind(up_3e_hyp_dataset, loop_dataset)
}

ggplot(up_3e_hyp_dataset, aes(x=hyp_3e_z_score_up))+
  geom_histogram(bins = 400)


# down loop

down_3e_hyp_dataset <- data.frame(patient=character(), avg_z_score=numeric(), stringsAsFactors = FALSE)

for (i in patients) {
  
  #filter dataframe
  patient_level <- exp %>% 
    dplyr::select(i) %>%
    rownames_to_column("Hugo_Symbol") %>% 
    filter(Hugo_Symbol %in% down_3e_hyp$symbol)
  
  all_values <- as.vector(patient_level[,2])
  
  
  #geometric mean
  
  down_genes_z_score <- mean(all_values, na.rm=TRUE)
  
  loop_dataset <- data.frame(patient=i, hyp_3e_z_score_down = down_genes_z_score)
  
  down_3e_hyp_dataset <- rbind(down_3e_hyp_dataset, loop_dataset)
}

ggplot(down_3e_hyp_dataset, aes(x=hyp_3e_z_score_down))+
  geom_histogram(bins = 400)


# merge datasets

hyp_3e_patient_scores <- left_join(up_3e_hyp_dataset, down_3e_hyp_dataset, by="patient")

hyp_3e_patient_scores <- hyp_3e_patient_scores %>% 
  mutate(total_z_score = hyp_3e_z_score_up - hyp_3e_z_score_down)

#visualize distribution

ggplot(hyp_3e_patient_scores, aes(x=total_z_score))+
  geom_histogram(bins = 400)



### Stratify based on z-score

quantile_groups <- quantile(hyp_3e_patient_scores$total_z_score, probs=seq(0,1,.25), na.rm=TRUE)

hyp_3e_patient_scores$quantile <- cut(hyp_3e_patient_scores$total_z_score, breaks = quantile_groups, include.lowest = TRUE, labels = FALSE)

class(hyp_3e_patient_scores$patient)
class(clin$PATIENT_ID)

hyp_3e_patient_scores$patient %in% clin

hyp_3e_patient_scores$patient <- gsub("\\.", "-", hyp_3e_patient_scores$patient)


#bind clin data with z score



all_data_3e_hyp <- left_join(clin, hyp_3e_patient_scores, by=c("PATIENT_ID"="patient"))


#plot

fit_all_3e_hyp <- survfit(Surv(OS_YEARS, OS_STATUS) ~ quantile, data = all_data_3e_hyp)


coxfit <- coxph(Surv(OS_YEARS, OS_STATUS) ~ quantile, all_data_3e_hyp)
summary_coxfit_3e_norm <- summary(coxfit)


hr <- round(summary_coxfit_3e_norm$coefficients[1, "exp(coef)"], 2)
pval <- format.pval(summary_coxfit_3e_norm$coefficients[1, "Pr(>|z|)"], digits = 2, eps = 0.001)

surv_plot_3e_hyp <- ggsurvplot(fit_all_3e_hyp, data = all_data_3e_hyp, size = 1, palette = c("#E7B800", "pink", "purple", "#2E9FDF"),legend.labs = c("depleted for eIF3e signature (hypoxia): low (Q1)","depleted: medium-low (Q2)", "enriched: medium-high (Q3)", "enriched for eIF3e signature (hypoxia): high (Q4)"),  break.time.by = 1, ylab="Overall Survival", xlab = "Time in years", xlim = c(0,10),conf.int = TRUE, pval = FALSE, risk.table = FALSE,  risk.table.col = NA, risk.table.height = 0.25, ggtheme = theme_bw())



surv_plot_3e_hyp$plot <- surv_plot_3e_hyp$plot + 
  annotate(
    "text", 
    x = 3, y = 0.2, 
    label = paste("HR =", hr, "\np =", pval), 
    size = 5, 
    color = "black"
  )+
  theme(text = element_text(size = 14))

surv_plot_3e_hyp

ggsave("3e_hyp_surv_plot.pdf", path=here("plots"),width = 11.5, height=8)



```


# eIF3d
### Hypoxia

```{r}

#expression matrix

exp <- merged_zscores_matrix %>%
  as.data.frame() %>% 
  rownames_to_column("Hugo_Symbol") %>% 
  filter(Hugo_Symbol %in% sig_3d_hyp$symbol) %>% 
  column_to_rownames("Hugo_Symbol")

# up loop

patients <- colnames(merged_zscores_all)
patients <- patients[patients !="Hugo_Symbol"]


up_3d_hyp_dataset <- data.frame(patient=character(), avg_z_score=numeric(), stringsAsFactors = FALSE)

for (i in patients) {
  
  #filter dataframe
  patient_level <- exp %>% 
    dplyr::select(i) %>%
    rownames_to_column("Hugo_Symbol") %>% 
    filter(Hugo_Symbol %in% up_3d_hyp$symbol)
  
  all_values <- as.vector(patient_level[,2])
  
  
  #geometric mean
  
  up_genes_z_score <- mean(all_values)
  
  loop_dataset <- data.frame(patient=i, hyp_3d_z_score_up = up_genes_z_score)
  
  up_3d_hyp_dataset <- rbind(up_3d_hyp_dataset, loop_dataset)
}

ggplot(up_3d_hyp_dataset, aes(x=hyp_3d_z_score_up))+
  geom_histogram(bins = 400)


# down loop

down_3d_hyp_dataset <- data.frame(patient=character(), avg_z_score=numeric(), stringsAsFactors = FALSE)

for (i in patients) {
  
  #filter dataframe
  patient_level <- exp %>% 
    dplyr::select(i) %>%
    rownames_to_column("Hugo_Symbol") %>% 
    filter(Hugo_Symbol %in% down_3d_hyp$symbol)
  
  all_values <- as.vector(patient_level[,2])
  
  
  #geometric mean
  
  down_genes_z_score <- mean(all_values)
  
  loop_dataset <- data.frame(patient=i, hyp_3d_z_score_down = down_genes_z_score)
  
  down_3d_hyp_dataset <- rbind(down_3d_hyp_dataset, loop_dataset)
}

ggplot(down_3d_hyp_dataset, aes(x=hyp_3d_z_score_down))+
  geom_histogram(bins = 400)


# merge datasets

hyp_3d_patient_scores <- left_join(up_3d_hyp_dataset, down_3d_hyp_dataset, by="patient")

hyp_3d_patient_scores <- hyp_3d_patient_scores %>% 
  mutate(total_z_score = hyp_3d_z_score_up - hyp_3d_z_score_down)

#visualize distribution

ggplot(hyp_3d_patient_scores, aes(x=total_z_score))+
  geom_histogram(bins = 400)



### Stratify based on z-score

quantile_groups <- quantile(hyp_3d_patient_scores$total_z_score, probs=seq(0,1,.25), na.rm=TRUE)

hyp_3d_patient_scores$quantile <- cut(hyp_3d_patient_scores$total_z_score, breaks = quantile_groups, include.lowest = TRUE, labels = FALSE)

hyp_3d_patient_scores$patient <- gsub("\\.", "-", as.character(hyp_3d_patient_scores$patient))


#bind clin data with z score

all_data_3d_hyp <- left_join(clin, hyp_3d_patient_scores, by=c("PATIENT_ID"="patient"))


#plot

fit_all_3d_hyp <- survfit(Surv(OS_YEARS, OS_STATUS) ~ quantile, data = all_data_3d_hyp)


coxfit <- coxph(Surv(OS_YEARS, OS_STATUS) ~ quantile, all_data_3d_hyp)
summary_coxfit_3d_norm <- summary(coxfit)


hr <- round(summary_coxfit_3d_norm$coefficients[1, "exp(coef)"], 2)
pval <- format.pval(summary_coxfit_3d_norm$coefficients[1, "Pr(>|z|)"], digits = 2, eps = 0.001)

surv_plot_3d_hyp <- ggsurvplot(fit_all_3d_hyp, data = all_data_3d_hyp, size = 1, palette = c("#E7B800", "pink", "purple", "#2E9FDF"),legend.labs = c("depleted for eIF3d signature (hypoxia): low (Q1)","depleted: medium-low (Q2)", "enriched: medium-high (Q3)", "enriched for eIF3d signature (hypoxia): high (Q4)"),  break.time.by = 1, ylab="Overall Survival", xlab = "Time in years", xlim = c(0,10),conf.int = TRUE, pval = FALSE, risk.table = FALSE,  risk.table.col = "strata", risk.table.height = 0.25, ggtheme = theme_bw())



surv_plot_3d_hyp$plot <- surv_plot_3d_hyp$plot + 
  annotate(
    "text", 
    x = 3, y = 0.2, 
    label = paste("HR =", hr, "\np =", pval), 
    size = 5, 
    color = "black"
  )+
  theme(text = element_text(size = 14))

surv_plot_3d_hyp

ggsave("3d_hyp_surv_plot.pdf", path=here("plots"),width = 11.5, height=8)






```



# eIF3d
### normoxia

```{r}

#expression matrix

exp <- merged_zscores_matrix %>%
  as.data.frame() %>% 
  rownames_to_column("Hugo_Symbol") %>% 
  filter(Hugo_Symbol %in% sig_3d_norm$symbol) %>% 
  column_to_rownames("Hugo_Symbol")

# up loop

patients <- colnames(merged_zscores_all)
patients <- patients[patients !="Hugo_Symbol"]


up_3d_norm_dataset <- data.frame(patient=character(), avg_z_score=numeric(), stringsAsFactors = FALSE)

for (i in patients) {
  
  #filter dataframe
  patient_level <- exp %>% 
    dplyr::select(i) %>%
    rownames_to_column("Hugo_Symbol") %>% 
    filter(Hugo_Symbol %in% up_3d_norm$symbol)
  
  all_values <- as.vector(patient_level[,2])
  
  
  #geometric mean
  
  up_genes_z_score <- mean(all_values)
  
  loop_dataset <- data.frame(patient=i, norm_3d_z_score_up = up_genes_z_score)
  
  up_3d_norm_dataset <- rbind(up_3d_norm_dataset, loop_dataset)
}

ggplot(up_3d_norm_dataset, aes(x=norm_3d_z_score_up))+
  geom_histogram(bins = 400)


# down loop

down_3d_norm_dataset <- data.frame(patient=character(), avg_z_score=numeric(), stringsAsFactors = FALSE)

for (i in patients) {
  
  #filter dataframe
  patient_level <- exp %>% 
    dplyr::select(i) %>%
    rownames_to_column("Hugo_Symbol") %>% 
    filter(Hugo_Symbol %in% down_3d_norm$symbol)
  
  all_values <- as.vector(patient_level[,2])
  
  
  #geometric mean
  
  down_genes_z_score <- mean(all_values)
  
  loop_dataset <- data.frame(patient=i, norm_3d_z_score_down = down_genes_z_score)
  
  down_3d_norm_dataset <- rbind(down_3d_norm_dataset, loop_dataset)
}

ggplot(down_3d_norm_dataset, aes(x=norm_3d_z_score_down))+
  geom_histogram(bins = 400)


# merge datasets

norm_3d_patient_scores <- left_join(up_3d_norm_dataset, down_3d_norm_dataset, by="patient")

norm_3d_patient_scores <- norm_3d_patient_scores %>% 
  mutate(total_z_score = norm_3d_z_score_up - norm_3d_z_score_down)

#visualize distribution

ggplot(norm_3d_patient_scores, aes(x=total_z_score))+
  geom_histogram(bins = 400)



### Stratify based on z-score

quantile_groups <- quantile(norm_3d_patient_scores$total_z_score, probs=seq(0,1,.25), na.rm=TRUE)

norm_3d_patient_scores$quantile <- cut(norm_3d_patient_scores$total_z_score, breaks = quantile_groups, include.lowest = TRUE, labels = FALSE)

norm_3d_patient_scores$patient <- gsub("\\.", "-", as.character(norm_3d_patient_scores$patient))


#bind clin data with z score

all_data_3d_norm <- left_join(clin, norm_3d_patient_scores, by=c("PATIENT_ID"="patient"))


#plot

fit_all_3d_norm <- survfit(Surv(OS_YEARS, OS_STATUS) ~ quantile, data = all_data_3d_norm)


coxfit <- coxph(Surv(OS_YEARS, OS_STATUS) ~ quantile, all_data_3d_norm)
summary_coxfit_3d_norm <- summary(coxfit)


hr <- round(summary_coxfit_3d_norm$coefficients[1, "exp(coef)"], 2)
pval <- format.pval(summary_coxfit_3d_norm$coefficients[1, "Pr(>|z|)"], digits = 2, eps = 0.001)

surv_plot_3d_norm <- ggsurvplot(fit_all_3d_norm, data = all_data_3d_norm, size = 1, palette = c("#E7B800", "pink", "purple", "#2E9FDF"),legend.labs = c("depleted for eIF3d signature (normoxia): low (Q1)","depleted: medium-low (Q2)", "enriched: medium-high (Q3)", "enriched for eIF3d signature (normoxia): high (Q4)"),  break.time.by = 1, ylab="Overall Survival", xlab = "Time in years", xlim = c(0,10),conf.int = TRUE, pval = FALSE, risk.table = FALSE,  risk.table.col = "strata", risk.table.height = 0.25, ggtheme = theme_bw())



surv_plot_3d_norm$plot <- surv_plot_3d_norm$plot + 
  annotate(
    "text", 
    x = 3, y = 0.2, 
    label = paste("HR =", hr, "\np =", pval), 
    size = 5, 
    color = "black"
  )+
  theme(text = element_text(size = 14))

surv_plot_3d_norm

ggsave("3d_norm_surv_plot.pdf", path=here("plots"),width = 11.5, height=8)



```


# a209 normoxia

```{r}

exp <- merged_zscores_matrix %>%
  as.data.frame() %>% 
  rownames_to_column("Hugo_Symbol") %>% 
  filter(Hugo_Symbol %in% sig_a209_norm$symbol) %>% 
  column_to_rownames("Hugo_Symbol")

# up loop

patients <- colnames(merged_zscores_all)
patients <- patients[patients !="Hugo_Symbol"]


up_a209_norm_dataset <- data.frame(patient=character(), avg_z_score=numeric(), stringsAsFactors = FALSE)

for (i in patients) {
  
  #filter dataframe
  patient_level <- exp %>% 
    dplyr::select(i) %>%
    rownames_to_column("Hugo_Symbol") %>% 
    filter(Hugo_Symbol %in% up_a209_norm$symbol)
  
  all_values <- as.vector(patient_level[,2])
  
  
  #geometric mean
  
  up_genes_z_score <- mean(all_values)
  
  loop_dataset <- data.frame(patient=i, norm_a209_z_score_up = up_genes_z_score)
  
  up_a209_norm_dataset <- rbind(up_a209_norm_dataset, loop_dataset)
}

ggplot(up_a209_norm_dataset, aes(x=norm_a209_z_score_up))+
  geom_histogram(bins = 400)


# down loop

down_a209_norm_dataset <- data.frame(patient=character(), avg_z_score=numeric(), stringsAsFactors = FALSE)

for (i in patients) {
  
  #filter dataframe
  patient_level <- exp %>% 
    dplyr::select(i) %>%
    rownames_to_column("Hugo_Symbol") %>% 
    filter(Hugo_Symbol %in% down_a209_norm$symbol)
  
  all_values <- as.vector(patient_level[,2])
  
  
  #geometric mean
  
  down_genes_z_score <- mean(all_values)
  
  loop_dataset <- data.frame(patient=i, norm_a209_z_score_down = down_genes_z_score)
  
  down_a209_norm_dataset <- rbind(down_a209_norm_dataset, loop_dataset)
}

ggplot(down_a209_norm_dataset, aes(x=norm_a209_z_score_down))+
  geom_histogram(bins = 400)


# merge datasets

norm_a209_patient_scores <- left_join(up_a209_norm_dataset, down_a209_norm_dataset, by="patient")

norm_a209_patient_scores <- norm_a209_patient_scores %>% 
  mutate(total_z_score = norm_a209_z_score_up - norm_a209_z_score_down)

#visualize distribution

ggplot(norm_a209_patient_scores, aes(x=total_z_score))+
  geom_histogram(bins = 400)



### Stratify based on z-score

quantile_groups <- quantile(norm_a209_patient_scores$total_z_score, probs=seq(0,1,.25), na.rm=TRUE)

norm_a209_patient_scores$quantile <- cut(norm_a209_patient_scores$total_z_score, breaks = quantile_groups, include.lowest = TRUE, labels = FALSE)

norm_a209_patient_scores$patient <- gsub("\\.", "-", as.character(norm_a209_patient_scores$patient))


#bind clin data with z score

all_data_a209_norm <- left_join(clin, norm_a209_patient_scores, by=c("PATIENT_ID"="patient"))


#plot

fit_all_a209_norm <- survfit(Surv(OS_YEARS, OS_STATUS) ~ quantile, data = all_data_a209_norm)


coxfit <- coxph(Surv(OS_YEARS, OS_STATUS) ~ quantile, all_data_a209_norm)
summary_coxfit_a209_norm <- summary(coxfit)


hr <- round(summary_coxfit_a209_norm$coefficients[1, "exp(coef)"], 2)
pval <- format.pval(summary_coxfit_a209_norm$coefficients[1, "Pr(>|z|)"], digits = 2, eps = 0.001)

surv_plot_a209_norm <- ggsurvplot(fit_all_a209_norm, data = all_data_a209_norm, size = 1, palette = c("#E7B800", "pink", "purple", "#2E9FDF"),legend.labs = c("depleted for a209 signature (normoxia): low (Q1)","depleted: medium-low (Q2)", "enriched: medium-high (Q3)", "enriched for 209 signature (normoxia): high (Q4)"),  break.time.by = 1, ylab="Overall Survival", xlab = "Time in years", xlim = c(0,10),conf.int = TRUE, pval = FALSE, risk.table = FALSE,  risk.table.col = "strata", risk.table.height = 0.25, ggtheme = theme_bw())



surv_plot_a209_norm$plot <- surv_plot_a209_norm$plot + 
  annotate(
    "text", 
    x = 3, y = 0.2, 
    label = paste("HR =", hr, "\np =", pval), 
    size = 5, 
    color = "black"
  )+
  theme(text = element_text(size = 14))

surv_plot_a209_norm

ggsave("a209_norm_surv_plot.pdf", path=here("plots"),width = 11.5, height=8)

```

# a209 hypoxia

```{r}

exp <- merged_zscores_matrix %>%
  as.data.frame() %>% 
  rownames_to_column("Hugo_Symbol") %>% 
  filter(Hugo_Symbol %in% sig_a209_hyp$symbol) %>% 
  column_to_rownames("Hugo_Symbol")

# up loop

patients <- colnames(merged_zscores_all)
patients <- patients[patients !="Hugo_Symbol"]


up_a209_hyp_dataset <- data.frame(patient=character(), avg_z_score=numeric(), stringsAsFactors = FALSE)

for (i in patients) {
  
  #filter dataframe
  patient_level <- exp %>% 
    dplyr::select(i) %>%
    rownames_to_column("Hugo_Symbol") %>% 
    filter(Hugo_Symbol %in% up_a209_hyp$symbol)
  
  all_values <- as.vector(patient_level[,2])
  
  
  #geometric mean
  
  up_genes_z_score <- mean(all_values)
  
  loop_dataset <- data.frame(patient=i, hyp_a209_z_score_up = up_genes_z_score)
  
  up_a209_hyp_dataset <- rbind(up_a209_hyp_dataset, loop_dataset)
}

ggplot(up_a209_hyp_dataset, aes(x=hyp_a209_z_score_up))+
  geom_histogram(bins = 400)


# down loop

down_a209_hyp_dataset <- data.frame(patient=character(), avg_z_score=numeric(), stringsAsFactors = FALSE)

for (i in patients) {
  
  #filter dataframe
  patient_level <- exp %>% 
    dplyr::select(i) %>%
    rownames_to_column("Hugo_Symbol") %>% 
    filter(Hugo_Symbol %in% down_a209_hyp$symbol)
  
  all_values <- as.vector(patient_level[,2])
  
  
  #geometric mean
  
  down_genes_z_score <- mean(all_values)
  
  loop_dataset <- data.frame(patient=i, hyp_a209_z_score_down = down_genes_z_score)
  
  down_a209_hyp_dataset <- rbind(down_a209_hyp_dataset, loop_dataset)
}

ggplot(down_a209_hyp_dataset, aes(x=hyp_a209_z_score_down))+
  geom_histogram(bins = 400)


# merge datasets

hyp_a209_patient_scores <- left_join(up_a209_hyp_dataset, down_a209_hyp_dataset, by="patient")

hyp_a209_patient_scores <- hyp_a209_patient_scores %>% 
  mutate(total_z_score = hyp_a209_z_score_up - hyp_a209_z_score_down)

#visualize distribution

ggplot(hyp_a209_patient_scores, aes(x=total_z_score))+
  geom_histogram(bins = 400)



### Stratify based on z-score

quantile_groups <- quantile(hyp_a209_patient_scores$total_z_score, probs=seq(0,1,.25), na.rm=TRUE)

hyp_a209_patient_scores$quantile <- cut(hyp_a209_patient_scores$total_z_score, breaks = quantile_groups, include.lowest = TRUE, labels = FALSE)

hyp_a209_patient_scores$patient <- gsub("\\.", "-", as.character(hyp_a209_patient_scores$patient))


#bind clin data with z score

all_data_a209_hyp <- left_join(clin, hyp_a209_patient_scores, by=c("PATIENT_ID"="patient"))


#plot

fit_all_a209_hyp <- survfit(Surv(OS_YEARS, OS_STATUS) ~ quantile, data = all_data_a209_hyp)


coxfit <- coxph(Surv(OS_YEARS, OS_STATUS) ~ quantile, all_data_a209_hyp)
summary_coxfit_a209_hyp <- summary(coxfit)


hr <- round(summary_coxfit_a209_hyp$coefficients[1, "exp(coef)"], 2)
pval <- format.pval(summary_coxfit_a209_hyp$coefficients[1, "Pr(>|z|)"], digits = 2, eps = 0.001)

surv_plot_a209_hyp <- ggsurvplot(fit_all_a209_hyp, data = all_data_a209_hyp, size = 1, palette = c("#E7B800", "pink", "purple", "#2E9FDF"),legend.labs = c("depleted for a209 signature (hypoxia): low (Q1)","depleted: medium-low (Q2)", "enriched: medium-high (Q3)", "enriched for 209 signature (hypoxia): high (Q4)"),  break.time.by = 1, ylab="Overall Survival", xlab = "Time in years", xlim = c(0,10),conf.int = TRUE, pval = FALSE, risk.table = FALSE,  risk.table.col = "strata", risk.table.height = 0.25, ggtheme = theme_bw())



surv_plot_a209_hyp$plot <- surv_plot_a209_hyp$plot + 
  annotate(
    "text", 
    x = 3, y = 0.2, 
    label = paste("HR =", hr, "\np =", pval), 
    size = 5, 
    color = "black"
  )+
  theme(text = element_text(size = 14))

surv_plot_a209_hyp

ggsave("a209_hyp_surv_plot.pdf", path=here("plots"),width = 11.5, height=8)









```







# Look at how the four quartiles for eIF3e expression (or others) correlate with grade/stage/sensitivity to treatment etc.


3e normoxia with clin is called all_data
```{r}

quantile_labels <- c("depleted for eIF3e KD signature: low (Q1)","depleted: medium-low (Q2)", "enriched: medium-high (Q3)", "enriched for eIF3e KD signature: high (Q4)")

# all_data_labeled <- all_data %>% 
#   mutate(ifelse(quant))

ggplot(all_data, aes(fill=RFS_STATUS, x=quantile, y=1)) + 
    geom_bar(position="fill", stat="identity")+
  labs(title = "Reccurance-Free Survival by 3e-normoxia signature",
       y = "Percent of Patients") +
  theme_minimal()
print(quantile_labels)

```

3d normoxia
```{r}
ggplot(all_data_3d_norm, aes(fill=RFS_STATUS, x=quantile, y=1)) + 
    geom_bar(position="fill", stat="identity")+
  labs(title = "Reccurance-Free Survival by 3e-normoxia signature",
       y = "Percent of Patients") +
  theme_minimal()
print(quantile_labels)



```



209 normoxia
```{r}

ggplot(all_data_a209_norm, aes(fill=RFS_STATUS, x=quantile, y=1)) + 
    geom_bar(position="fill", stat="identity")+
  labs(title = "Reccurance-Free Survival by 3e-normoxia signature",
       y = "Percent of Patients") +
  theme_minimal()
print(quantile_labels)

ggplot(all_data_a209_hyp, aes(fill=RFS_STATUS, x=quantile, y=1)) + 
    geom_bar(position="fill", stat="identity")+
  labs(title = "Reccurance-Free Survival by 3e-normoxia signature",
       y = "Percent of Patients") +
  theme_minimal()
print(quantile_labels)

```
















Hypoxia signature in breast cancer from ye et al
https://www.ncbi.nlm.nih.gov/pmc/articles/PMC6279594/#:~:text=The%2042%2Dgene%20expression%20signature,mediate%20the%20conserved%20hypoxic%20response

```{r}
ye_hyp_sig <- read_excel(here("other_data/hypoxic_sig_ye.xlsx"))

#these are only up values-- so give z score values here

patients <- colnames(merged_zscores_all)
patients <- patients[patients !="Hugo_Symbol"]


ye_hif_dataset <- data.frame(patient=character(), avg_z_score=numeric(), stringsAsFactors = FALSE)

for (i in patients) {
  
  #filter dataframe
  patient_level <- exp %>% 
    dplyr::select(i) %>%
    rownames_to_column("Hugo_Symbol") %>% 
    filter(Hugo_Symbol %in% ye_hyp_sig$up_in_hypoxia)
  
  all_values <- as.vector(patient_level[,2])
  
  
  #geometric mean
  
  up_genes_z_score <- mean(all_values, na.rm=TRUE)
  
  loop_dataset <- data.frame(patient=i, ye_hyp_sig_up = up_genes_z_score)
  
  ye_hif_dataset <- rbind(ye_hif_dataset, loop_dataset)
}

#plot distribution
ggplot(ye_hif_dataset, aes(x=ye_hyp_sig_up))+
  geom_histogram(bins = 400)


ye_hif_dataset$patient <- gsub("\\.", "-", as.character(ye_hif_dataset$patient))


### Stratify based on z-score

quantile_groups <- quantile(ye_hif_dataset$ye_hyp_sig_up, probs=seq(0,1,.25), na.rm=TRUE)

ye_hif_dataset$quantile <- cut(ye_hif_dataset$ye_hyp_sig_up, breaks = quantile_groups, include.lowest = TRUE, labels = FALSE)

ye_hif_dataset$patient <- gsub("\\.", "-", as.character(ye_hif_dataset$patient))


#bind clin data with z score

all_data_hif_ye <- left_join(clin, ye_hif_dataset, by=c("PATIENT_ID"="patient"))


#plot

fit_all_data_hif_ye <- survfit(Surv(OS_YEARS, OS_STATUS) ~ quantile, data = all_data_hif_ye)


coxfit <- coxph(Surv(OS_YEARS, OS_STATUS) ~ quantile, all_data_hif_ye)
summary_coxfit_ye <- summary(coxfit)


hr <- round(summary_coxfit_ye$coefficients[1, "exp(coef)"], 2)
pval <- format.pval(summary_coxfit_ye$coefficients[1, "Pr(>|z|)"], digits = 2, eps = 0.001)

surv_plot_ye <- ggsurvplot(fit_all_data_hif_ye, data = all_data_hif_ye, size = 1, palette = c("#E7B800", "pink", "purple", "#2E9FDF"),legend.labs = c("depleted for ye hypoxia signature: low (Q1)","depleted: medium-low (Q2)", "enriched: medium-high (Q3)", "enriched for ye hypoxia signature: high (Q4)"),  break.time.by = 1, ylab="Overall Survival", xlab = "Time in years", xlim = c(0,10),conf.int = TRUE, pval = FALSE, risk.table = FALSE,  risk.table.col = "strata", risk.table.height = 0.25, ggtheme = theme_bw())



surv_plot_ye$plot <- surv_plot_ye$plot + 
  annotate(
    "text", 
    x = 3, y = 0.2, 
    label = paste("HR =", hr, "\np =", pval), 
    size = 5, 
    color = "black"
  ) + theme(text = element_text(size = 14))

surv_plot_ye

ggsave("surv_plot_ye.pdf", path=here("plots"),width = 11.5, height=8)





```


See if correlated with our sigs


#plot 3e score against ye hypoxia score

```{r}

patient_ye_and_3e <- left_join(patient_scores, ye_hif_dataset, by="patient")

ggplot(patient_ye_and_3e, aes(x=ye_hyp_sig_up, y= total_z_score))+
  geom_point()+
  xlab("Ye Hypoxia z score")+
  ylab("eIF3e KD (normoxia) z score")+
  theme_cowplot()+ 
  theme(text = element_text(size = 14))


ggsave("3e_hyp_and_ye.pdf", path=here("plots"),width = 4, height=3)




cor.test(patient_ye_and_3e$ye_hyp_sig_up, patient_ye_and_3e$total_z_score)
```


# now try for hypoxia 3e

```{r}

patient_ye_and_3e_hyp <- left_join(hyp_3e_patient_scores, ye_hif_dataset, by="patient")

ggplot(patient_ye_and_3e_hyp, aes(x=ye_hyp_sig_up, y= total_z_score))+
  geom_point()+
  xlab("Ye Hypoxia z score")+
  ylab("eIF3e (hypoxia) z score")+
  theme_cowplot() +
  geom_hline(yintercept = 0) +
  geom_vline(xintercept = 0)+
  theme(text = element_text(size = 14))


ggsave("3e_hyp_and_ye.pdf", path=here("plots"),width = 5, height=4)

# remove z scores less than 0.2, 0.2

patient_ye_and_3e_hyp <- patient_ye_and_3e_hyp %>% 
  mutate(change = ifelse(abs(total_z_score) < 0.1 & abs(ye_hyp_sig_up) < 0.1, "small_change", "big_change"))




cor.test(patient_ye_and_3e_hyp$ye_hyp_sig_up, patient_ye_and_3e_hyp$total_z_score)
```

Make four groups based on quandrants
```{r}

patient_ye_and_3e_hyp <- patient_ye_and_3e_hyp %>% 
  mutate(quadrant = ifelse(ye_hyp_sig_up < 0 & total_z_score < 0, "depleted hypoxia sig and depleted eIF3e (hypoxia) sig",
                           ifelse(ye_hyp_sig_up > 0 & total_z_score < 0, "enriched hypoxia sig and depleted eIF3e (hypoxia) sig",
                                  ifelse(ye_hyp_sig_up > 0 & total_z_score > 0, "enriched hypoxia sig and enriched eIF3e (hypoxia) sig",
                                         ifelse(ye_hyp_sig_up < 0 & total_z_score > 0, "depleted hypoxia sig and enriched eIF3e (hypoxia) sig", "other")))))

```

Plot survival curve
```{r}
#bind with clin data
patient_ye_and_3e_hyp_clin <- left_join(clin, patient_ye_and_3e_hyp, by=c("PATIENT_ID"="patient"))


#plot

fit_all_hypoxia <- survfit(Surv(OS_YEARS, OS_STATUS) ~ quadrant, data = patient_ye_and_3e_hyp_clin)


coxfit <- coxph(Surv(OS_YEARS, OS_STATUS) ~ quadrant, patient_ye_and_3e_hyp_clin)
summary_coxfit <- summary(coxfit)


hr <- round(summary_coxfit$coefficients[1, "exp(coef)"], 2)
pval <- format.pval(summary_coxfit$coefficients[1, "Pr(>|z|)"], digits = 2, eps = 0.001)

patient_ye_and_3e_hyp_clin$quadrant <- as.factor(patient_ye_and_3e_hyp_clin$quadrant)

quadrant_levels <- levels(patient_ye_and_3e_hyp_clin$quadrant)


surv_plot <- ggsurvplot(fit_all_hypoxia, data = patient_ye_and_3e_hyp_clin, size = 1, palette = c("#E7B800", "pink", "purple", "#2E9FDF"),legend.labs = quadrant_levels,  break.time.by = 1, ylab="Overall Survival", xlab = "Time in years", xlim = c(0,10),conf.int = TRUE, pval = FALSE, risk.table = FALSE,  risk.table.col = "strata", risk.table.height = 0.25, ggtheme = theme_bw())



surv_plot$plot <- surv_plot$plot + 
  annotate(
    "text", 
    x = 3, y = 0.2, 
    label = paste("HR =", hr, "\np =", pval), 
    size = 5, 
    color = "black"
  )+ theme(text = element_text(size = 14))

surv_plot

ggsave("surv_plot_3e_hyp_ye.pdf", path=here("plots"),width = 11.5, height=8)







```


Also excluding points in the middle as a negative control for the survival curve analysis
```{r}




big_changes_hyp <- patient_ye_and_3e_hyp %>% 
  filter(change=="big_change")

ggplot(big_changes_hyp, aes(x=ye_hyp_sig_up, y= total_z_score))+
  geom_point()+
  xlab("Ye Hypoxia z score")+
  ylab("eIF3e (hypoxia) z score")+
  theme_cowplot() +
  geom_hline(yintercept = 0) +
  geom_vline(xintercept = 0)+
  theme(text = element_text(size = 14))

# ggsave("3e_hyp_and_ye_big_changes.pdf", path=here("plots"),width = 5, height=4)

cor.test(big_changes_hyp$ye_hyp_sig_up, big_changes_hyp$total_z_score)


# make four groups

big_changes_hyp <- big_changes_hyp %>% 
  mutate(quadrant = ifelse(ye_hyp_sig_up < 0 & total_z_score < 0, "depleted hypoxia sig and depleted eIF3e (hypoxia) sig",
                           ifelse(ye_hyp_sig_up > 0 & total_z_score < 0, "enriched hypoxia sig and depleted eIF3e (hypoxia) sig",
                                  ifelse(ye_hyp_sig_up > 0 & total_z_score > 0, "enriched hypoxia sig and enriched eIF3e (hypoxia) sig",
                                         ifelse(ye_hyp_sig_up < 0 & total_z_score > 0, "depleted hypoxia sig and enriched eIF3e (hypoxia) sig", "other")))))


# plot surival curve with those groups

#bind with clin data
patient_ye_and_3e_hyp_clin_big_changes <- left_join(clin, big_changes_hyp, by=c("PATIENT_ID"="patient"))


#plot

fit_all_hypoxia <- survfit(Surv(OS_YEARS, OS_STATUS) ~ quadrant, data = patient_ye_and_3e_hyp_clin_big_changes)


coxfit <- coxph(Surv(OS_YEARS, OS_STATUS) ~ quadrant, patient_ye_and_3e_hyp_clin_big_changes)
summary_coxfit <- summary(coxfit)


hr <- round(summary_coxfit$coefficients[1, "exp(coef)"], 2)
pval <- format.pval(summary_coxfit$coefficients[1, "Pr(>|z|)"], digits = 2, eps = 0.001)

patient_ye_and_3e_hyp_clin$quadrant <- as.factor(patient_ye_and_3e_hyp_clin_big_changes$quadrant)

quadrant_levels <- levels(patient_ye_and_3e_hyp_clin_big_changes$quadrant)


surv_plot <- ggsurvplot(fit_all_hypoxia, data = patient_ye_and_3e_hyp_clin, size = 1, palette = c("#E7B800", "pink", "purple", "#2E9FDF"),legend.labs = quadrant_levels,  break.time.by = 1, ylab="Overall Survival", xlab = "Time in years", xlim = c(0,10),conf.int = TRUE, pval = FALSE, risk.table = FALSE,  risk.table.col = "strata", risk.table.height = 0.25, ggtheme = theme_bw())



surv_plot$plot <- surv_plot$plot + 
  annotate(
    "text", 
    x = 3, y = 0.2, 
    label = paste("HR =", hr, "\np =", pval), 
    size = 5, 
    color = "black"
  )+ theme(text = element_text(size = 14))

surv_plot

ggsave("surv_plot_3e_hyp_ye_big changes.pdf", path=here("plots"),width = 11.5, height=8)










```

















Pretty cool!!!!

#a209

# now try for hypoxia a209

```{r}

patient_ye_and_a209_hyp <- left_join(hyp_a209_patient_scores, ye_hif_dataset, by="patient")

ggplot(patient_ye_and_a209_hyp, aes(x=ye_hyp_sig_up, y= total_z_score))+
  geom_point()+
  xlab("Ye Hypoxia z score")+
  ylab("a209 (hypoxia) z score")+
  theme_cowplot() +
  geom_hline(yintercept = 0) +
  geom_vline(xintercept = 0)+
  theme(text = element_text(size = 14))


ggsave("a209_hyp_and_ye.pdf", path=here("plots"),width = 5, height=4)



cor.test(patient_ye_and_a209_hyp$ye_hyp_sig_up, big_changes_hyp$total_z_score)


patient_ye_and_a209_hyp <- patient_ye_and_a209_hyp %>% 
  mutate(change = ifelse(abs(total_z_score) < 0.1 & abs(ye_hyp_sig_up) < 0.1, "small_change", "big_change"))




```

Make four groups based on quandrants
```{r}

patient_ye_and_a209_hyp <- patient_ye_and_a209_hyp %>% 
  mutate(quadrant = ifelse(ye_hyp_sig_up < 0 & total_z_score < 0, "depleted hypoxia sig and depleted a209 (hypoxia) sig",
                           ifelse(ye_hyp_sig_up > 0 & total_z_score < 0, "enriched hypoxia sig and depleted a209 (hypoxia) sig",
                                  ifelse(ye_hyp_sig_up > 0 & total_z_score > 0, "enriched hypoxia sig and enriched a209 (hypoxia) sig",
                                         ifelse(ye_hyp_sig_up < 0 & total_z_score > 0, "depleted hypoxia sig and enriched a209 (hypoxia) sig", "other")))))

```

Plot survival curve
```{r}
#bind with clin data
patient_ye_and_a209_hyp_clin <- left_join(clin, patient_ye_and_a209_hyp, by=c("PATIENT_ID"="patient"))


#plot

fit_all_hypoxia <- survfit(Surv(OS_YEARS, OS_STATUS) ~ quadrant, data = patient_ye_and_a209_hyp_clin)


coxfit <- coxph(Surv(OS_YEARS, OS_STATUS) ~ quadrant, patient_ye_and_a209_hyp_clin)
summary_coxfit <- summary(coxfit)


hr <- round(summary_coxfit$coefficients[1, "exp(coef)"], 2)
pval <- format.pval(summary_coxfit$coefficients[1, "Pr(>|z|)"], digits = 2, eps = 0.001)

patient_ye_and_a209_hyp_clin$quadrant <- as.factor(patient_ye_and_a209_hyp_clin$quadrant)

quadrant_levels <- levels(patient_ye_and_a209_hyp_clin$quadrant)


surv_plot <- ggsurvplot(fit_all_hypoxia, data = patient_ye_and_a209_hyp_clin, size = 1, palette = c("#E7B800", "pink", "purple", "#2E9FDF"),legend.labs = quadrant_levels,  break.time.by = 1, ylab="Overall Survival", xlab = "Time in years", xlim = c(0,10),conf.int = TRUE, pval = FALSE, risk.table = FALSE,  risk.table.col = "strata", risk.table.height = 0.25, ggtheme = theme_bw())

levels(patient_ye_and_a209_hyp_clin$quadrant)

surv_plot$plot <- surv_plot$plot + 
  annotate(
    "text", 
    x = 3, y = 0.2, 
    label = paste("HR =", hr, "\np =", pval), 
    size = 5, 
    color = "black"
  )+theme(text = element_text(size = 14))

surv_plot

ggsave("surv_plot_a209_hyp_ye.pdf", path=here("plots"),width = 11.5, height=8)



surv_plot




```

Limit to changes over 0.1 as a control
```{r}
big_changes_hyp <- patient_ye_and_a209_hyp %>% 
  filter(change=="big_change")

ggplot(big_changes_hyp, aes(x=ye_hyp_sig_up, y= total_z_score))+
  geom_point()+
  xlab("Ye Hypoxia z score")+
  ylab("a209 (hypoxia) z score")+
  theme_cowplot() +
  geom_hline(yintercept = 0) +
  geom_vline(xintercept = 0)+
  theme(text = element_text(size = 14))

ggsave("a209_hyp_and_ye_big_changes.pdf", path=here("plots"),width = 5, height=4)


cor.test(big_changes_hyp$ye_hyp_sig_up, big_changes_hyp$total_z_score)


# make four groups
big_changes_hyp <- big_changes_hyp %>% 
  mutate(quadrant = ifelse(ye_hyp_sig_up < 0 & total_z_score < 0, "depleted hypoxia sig and depleted a209 (hypoxia) sig",
                           ifelse(ye_hyp_sig_up > 0 & total_z_score < 0, "enriched hypoxia sig and depleted a209 (hypoxia) sig",
                                  ifelse(ye_hyp_sig_up > 0 & total_z_score > 0, "enriched hypoxia sig and enriched a209 (hypoxia) sig",
                                         ifelse(ye_hyp_sig_up < 0 & total_z_score > 0, "depleted hypoxia sig and enriched a209 (hypoxia) sig", "other")))))




# plot surival curve with those groups
#bind with clin data
patient_ye_and_a209_hyp_clin <- left_join(clin, big_changes_hyp, by=c("PATIENT_ID"="patient"))


#plot

fit_all_hypoxia <- survfit(Surv(OS_YEARS, OS_STATUS) ~ quadrant, data = patient_ye_and_a209_hyp_clin)


coxfit <- coxph(Surv(OS_YEARS, OS_STATUS) ~ quadrant, patient_ye_and_a209_hyp_clin)
summary_coxfit <- summary(coxfit)


hr <- round(summary_coxfit$coefficients[1, "exp(coef)"], 2)
pval <- format.pval(summary_coxfit$coefficients[1, "Pr(>|z|)"], digits = 2, eps = 0.001)

patient_ye_and_a209_hyp_clin$quadrant <- as.factor(patient_ye_and_a209_hyp_clin$quadrant)

quadrant_levels <- levels(patient_ye_and_a209_hyp_clin$quadrant)


surv_plot <- ggsurvplot(fit_all_hypoxia, data = patient_ye_and_a209_hyp_clin, size = 1, palette = c("#E7B800", "pink", "purple", "#2E9FDF"),legend.labs = quadrant_levels,  break.time.by = 1, ylab="Overall Survival", xlab = "Time in years", xlim = c(0,10),conf.int = TRUE, pval = FALSE, risk.table = FALSE,  risk.table.col = "strata", risk.table.height = 0.25, ggtheme = theme_bw())



surv_plot$plot <- surv_plot$plot + 
  annotate(
    "text", 
    x = 3, y = 0.2, 
    label = paste("HR =", hr, "\np =", pval), 
    size = 5, 
    color = "black"
  )+theme(text = element_text(size = 14))

surv_plot

ggsave("big_changes_surv_plot_a209_hyp_ye.pdf", path=here("plots"),width = 11.5, height=8)









```









# Controls


## Sanity check: positive-ish controls

VITAL_STATUS = living or died of disease


```{r}

# clin2 <- all_data[c(which(all_data$low_signature), which(all_data$high_signature)),]

alive_data <- all_data %>% 
  mutate(alive = ifelse(VITAL_STATUS=="Living", TRUE, FALSE))

alive_data <- alive_data %>% 
  mutate(died_from_cancer = ifelse(VITAL_STATUS=="Died of Disease", TRUE, FALSE))

fit_pos <- survfit(Surv(OS_YEARS, OS_STATUS) ~ died_from_cancer, data = alive_data)


ggsurvplot(fit_pos, data = alive_data, size = 1, palette = c("#E7B800", "#2E9FDF"),legend.labs = c("alive", "died_from_cancer"),  break.time.by = 1, ylab="Overall Survival", xlab = "Time in years", xlim = c(0,10),conf.int = TRUE, pval = TRUE, risk.table = TRUE,  risk.table.col = "strata", risk.table.height = 0.25, ggtheme = theme_bw())



```
Good sanity check! just need to clean up some of the alive vs died data??? maybe?

## Negative Control

Now neg control -- random genes comprising signatures-- same number of genes just random

pos genes = 1747 genes
neg genes = 1638 genes

pick random from all genes expressed in clinical data?? or in my data?


for loop generating z score for each patient



1. Create expression data
```{r}

exp_full <- merged_zscores_matrix %>%
  as.data.frame()

```

2. Pick random up and down values
```{r}

all_genes <- rownames(exp_full)

fake_pos_list <-all_genes[sample(1:length(all_genes), 1747)]
fake_neg_list <-all_genes[sample(1:length(all_genes), 1638)]
```

# fake up signature values - neg ctrl


Loop through each patient
```{r}

patients <- colnames(merged_zscores_all)
patients <- patients[patients !="Hugo_Symbol"]


fake_up_dataset <- data.frame(patient=character(), avg_z_score=numeric(), stringsAsFactors = FALSE)

for (i in patients) {

  #filter dataframe
  patient_level <- exp %>% 
    dplyr::select(i) %>%
    rownames_to_column("Hugo_Symbol") %>% 
    filter(Hugo_Symbol %in% fake_pos_list)

    all_values <- as.vector(patient_level[,2])
  
  
  #geometric mean
  
  up_genes_z_score <- mean(all_values)

  loop_dataset <- data.frame(patient=i, norm_3d_z_score_up = up_genes_z_score)
  
  fake_up_dataset <- rbind(fake_up_dataset, loop_dataset)
}

```





#fake down sig values - neg ctrl

```{r}

patients <- colnames(merged_zscores_all)
patients <- patients[patients !="Hugo_Symbol"]


fake_down_dataset <- data.frame(patient=character(), avg_z_score=numeric(), stringsAsFactors = FALSE)

for (i in patients) {

  #filter dataframe
  patient_level <- exp %>% 
    dplyr::select(i) %>%
    rownames_to_column("Hugo_Symbol") %>% 
    filter(Hugo_Symbol %in% fake_neg_list)

    all_values <- as.vector(patient_level[,2])
  
  
  #geometric mean
  
  down_genes_z_score <- mean(all_values)

  loop_dataset <- data.frame(patient=i, norm_3e_z_score_down = down_genes_z_score)
  
  fake_down_dataset <- rbind(fake_down_dataset, loop_dataset)
}



```


Merge two datasets
```{r}
neg_ctrl_fake_patient_scores <- left_join(fake_up_dataset, fake_down_dataset, by="patient")

neg_ctrl_fake_patient_scores <- neg_ctrl_fake_patient_scores %>% 
  mutate(total_z_score = norm_3e_z_score_up - norm_3e_z_score_down)

```

NEG CONTROL - visualize scores among patient cohort
```{r}
ggplot(neg_ctrl_fake_patient_scores, aes(x=total_z_score))+
  geom_histogram(bins = 400)
```


Stratify into groups based on z score

```{r}

neg_ctrl_quantile_groups <- quantile(neg_ctrl_fake_patient_scores$total_z_score, probs=seq(0,1,.25), na.rm=TRUE)

neg_ctrl_fake_patient_scores$quantile <- cut(neg_ctrl_fake_patient_scores$total_z_score, breaks = quantile_groups, include.lowest = TRUE, labels = FALSE)

neg_ctrl_fake_patient_scores$patient <- gsub("\\.", "-", as.character(neg_ctrl_fake_patient_scores$patient))


colnames(neg_ctrl_fake_patient_scores) <- paste(colnames(neg_ctrl_fake_patient_scores),"neg_ctrl",sep="_") 

names(neg_ctrl_fake_patient_scores)[names(neg_ctrl_fake_patient_scores) == "patient_neg_ctrl"] <- "patient"




```


Now plot neg control!


```{r}
all_data <- left_join(clin, neg_ctrl_fake_patient_scores, by=c("PATIENT_ID"="patient"))


all_data <- all_data %>% 
  mutate(neg_ctrl_high_signature = ifelse(quantile_neg_ctrl==4, TRUE, FALSE))

all_data <- all_data %>% 
  mutate(neg_ctrl_low_signature = ifelse(quantile_neg_ctrl==1, TRUE, FALSE))
```


```{r}
clin2 <- all_data[c(which(all_data$neg_ctrl_low_signature), which(all_data$neg_ctrl_high_signature)),]
fit <- survfit(Surv(OS_YEARS, OS_STATUS) ~ neg_ctrl_low_signature, data = clin2)


ggsurvplot(fit, data = clin2, size = 1, palette = c("#E7B800", "#2E9FDF"),legend.labs = c("NEG CTRL eIF3e KD signature high", "NEG CTRL eIF3e KD signature low"),  break.time.by = 1, ylab="Overall Survival", xlab = "Time in years", xlim = c(0,10),conf.int = TRUE, pval = TRUE, risk.table = TRUE,  risk.table.col = "strata", risk.table.height = 0.25, ggtheme = theme_bw())

```



# Repeat analysis with TCGA dataset

1,108 samples

```{r cache = TRUE}
zscores_tcga <- read.table(here("cbioportal_data/brca_tcga/data_mrna_seq_v2_rsem_zscores_ref_diploid_samples.txt"), sep="\t", header=T)
row.names(zscores) <- gsub("_", ".",row.names(zscores))

# there are duplicates in this list. What happens when i subset for the genes we are interested in?

zscores_tcga_all_symbol <- zscores_tcga %>% 
  dplyr::select(-Entrez_Gene_Id)

### Average scores for duplicates

merged_tcga_zscores_all <- zscores_tcga_all_symbol %>%
  group_by(Hugo_Symbol) %>%
  summarise(across(everything(), mean))


merged_tcga_zscores_matrix <- merged_tcga_zscores_all %>% 
  column_to_rownames("Hugo_Symbol") %>% 
  as.matrix()


```

Define genes of interest
```{r}
genes <- sig_3e_norm$symbol
```



```{r}

verified_genes <- genes[genes %in% rownames(merged_tcga_zscores_matrix)]

filtered_expr <- merged_tcga_zscores_matrix[verified_genes, , drop = FALSE]


```



for loop generating z score for each patient

1. Create expression data
```{r}

exp <- merged_tcga_zscores_matrix %>%
  as.data.frame() %>% 
  rownames_to_column("Hugo_Symbol") %>% 
    filter(Hugo_Symbol %in% sig_3e_norm$symbol) %>% 
 column_to_rownames("Hugo_Symbol")


```




#up values


Loop through each patient
```{r}

patients <- colnames(merged_tcga_zscores_all)
patients <- patients[patients !="Hugo_Symbol"]


tcga_up_3e_norm_dataset <- data.frame(patient=character(), avg_z_score=numeric(), stringsAsFactors = FALSE)

for (i in patients) {

  #filter dataframe
  patient_level <- exp %>% 
    dplyr::select(i) %>%
    rownames_to_column("Hugo_Symbol") %>% 
    filter(Hugo_Symbol %in% up_3e_norm$symbol)

    all_values <- as.vector(patient_level[,2])
  
  
  #geometric mean
  
  up_genes_z_score <- mean(all_values, na.rm=TRUE)

  loop_dataset <- data.frame(patient=i, norm_3e_z_score_up = up_genes_z_score)
  
  tcga_up_3e_norm_dataset <- rbind(tcga_up_3e_norm_dataset, loop_dataset)
}

```





#down values

```{r}

patients <- colnames(merged_tcga_zscores_all)
patients <- patients[patients !="Hugo_Symbol"]


tcga_down_3e_norm_dataset <- data.frame(patient=character(), avg_z_score=numeric(), stringsAsFactors = FALSE)

for (i in patients) {

  #filter dataframe
  patient_level <- exp %>% 
    dplyr::select(i) %>%
    rownames_to_column("Hugo_Symbol") %>% 
    filter(Hugo_Symbol %in% down_3e_norm$symbol)

    all_values <- as.vector(patient_level[,2])
  
  
  #geometric mean
  
  down_genes_z_score <- mean(all_values, na.rm=TRUE)

  loop_dataset <- data.frame(patient=i, norm_3e_z_score_down = down_genes_z_score)
  
  tcga_down_3e_norm_dataset <- rbind(tcga_down_3e_norm_dataset, loop_dataset)
}



```


Merge two datasets
```{r}
patient_scores_tcga <- left_join(tcga_up_3e_norm_dataset, tcga_down_3e_norm_dataset, by="patient")

patient_scores_tcga <- patient_scores_tcga %>% 
  mutate(total_z_score = norm_3e_z_score_up - norm_3e_z_score_down)

```

visualize scores among patient cohort
```{r}
ggplot(patient_scores_tcga, aes(x=total_z_score))+
  geom_histogram(bins = 400)
```


Stratify into groups based on z score

```{r}

quantile_groups <- quantile(patient_scores_tcga$total_z_score, probs=seq(0,1,.25), na.rm=TRUE)

patient_scores_tcga$quantile <- cut(patient_scores_tcga$total_z_score, breaks = quantile_groups, include.lowest = TRUE, labels = FALSE)

patient_scores_tcga$patient <- gsub("\\.", "-", as.character(patient_scores_tcga$patient))



```





## Switch to using survival data
Read in and clean up clin data
Read in and clean up clin data
  
```{r}

# clin_tcga <- read.table(here("cbioportal_data/brca_tcga/data_clinical_patient.txt"), header=T, sep="t")
# dim(clin_tcga)
# 
# clin_tcga$OS_STATUS[which(clin_tcga$OS_STATUS == "1:DECEASED" & clin_tcga$OS_MONTHS > 120)] <- "0:LIVING"
# clin_tcga$OS_STATUS <- clin_tcga$OS_STATUS == "1:DECEASED"
# clin_tcga <- cbind(clin_tcga, OS_YEARS = clin_tcga$OS_MONTHS/12)
# clin_tcga$OS_YEARS[which(clin_tcga$OS_YEARS >= 10)] <- 10
# dim(clin_tcga)


```


Bind clin data with z scores

```{r}
all_data <- left_join(clin, patient_scores, by=c("PATIENT_ID"="patient"))


all_data <- all_data %>% 
  mutate(high_signature = ifelse(quantile==4, TRUE, FALSE))

all_data <- all_data %>% 
  mutate(low_signature = ifelse(quantile==1, TRUE, FALSE))
```



Stratifying survival data
## eif3e signature vs survival

```{r}
clin2 <- all_data[c(which(all_data$low_signature), which(all_data$high_signature)),]
fit <- survfit(Surv(OS_YEARS, OS_STATUS) ~ low_signature, data = clin2)


ggsurvplot(fit, data = clin2, size = 1, palette = c("#E7B800", "#2E9FDF"),legend.labs = c("eIF3e KD signature high", "eIF3e KD signature low"),  break.time.by = 1, ylab="Overall Survival", xlab = "Time in years", xlim = c(0,10),conf.int = TRUE, pval = TRUE, risk.table = TRUE,  risk.table.col = "strata", risk.table.height = 0.25, ggtheme = theme_bw())

```





## Sanity check: positive-ish controls

VITAL_STATUS = living or died of disease


```{r}

clin2 <- all_data[c(which(all_data$low_signature), which(all_data$high_signature)),]

all_data <- all_data %>% 
  mutate(alive = ifelse(VITAL_STATUS=="Living", TRUE, FALSE))

all_data <- all_data %>% 
  mutate(died_from_cancer = ifelse(VITAL_STATUS=="Died of Disease", TRUE, FALSE))

fit_pos <- survfit(Surv(OS_YEARS, OS_STATUS) ~ died_from_cancer, data = clin2)


ggsurvplot(fit_pos, data = clin2, size = 1, palette = c("#E7B800", "#2E9FDF"),legend.labs = c("alive", "died_from_cancer"),  break.time.by = 1, ylab="Overall Survival", xlab = "Time in years", xlim = c(0,10),conf.int = TRUE, pval = TRUE, risk.table = TRUE,  risk.table.col = "strata", risk.table.height = 0.25, ggtheme = theme_bw())



```
Good sanity check! just need to clean up some of the alive vs died data??? maybe?

## Negative Control

Now neg control -- random genes comprising signatures-- same number of genes just random

pos genes = 1747 genes
neg genes = 1638 genes

pick random from all genes expressed in clinical data?? or in my data?


for loop generating z score for each patient



1. Create expression data
```{r}

exp_full <- merged_zscores_matrix %>%
  as.data.frame()

```

2. Pick random up and down values
```{r}

all_genes <- rownames(exp_full)

fake_pos_list <-all_genes[sample(1:length(all_genes), 1747)]
fake_neg_list <-all_genes[sample(1:length(all_genes), 1638)]
```

# fake up signature values - neg ctrl


Loop through each patient
```{r}

patients <- colnames(merged_zscores_all)
patients <- patients[patients !="Hugo_Symbol"]


fake_up_dataset <- data.frame(patient=character(), avg_z_score=numeric(), stringsAsFactors = FALSE)

for (i in patients) {

  #filter dataframe
  patient_level <- exp %>% 
    dplyr::select(i) %>%
    rownames_to_column("Hugo_Symbol") %>% 
    filter(Hugo_Symbol %in% fake_pos_list)

    all_values <- as.vector(patient_level[,2])
  
  
  #geometric mean
  
  up_genes_z_score <- mean(all_values)

  loop_dataset <- data.frame(patient=i, norm_3e_z_score_up = up_genes_z_score)
  
  fake_up_dataset <- rbind(fake_up_dataset, loop_dataset)
}

```





#fake down sig values - neg ctrl

```{r}

patients <- colnames(merged_zscores_all)
patients <- patients[patients !="Hugo_Symbol"]


fake_down_dataset <- data.frame(patient=character(), avg_z_score=numeric(), stringsAsFactors = FALSE)

for (i in patients) {

  #filter dataframe
  patient_level <- exp %>% 
    dplyr::select(i) %>%
    rownames_to_column("Hugo_Symbol") %>% 
    filter(Hugo_Symbol %in% fake_neg_list)

    all_values <- as.vector(patient_level[,2])
  
  
  #geometric mean
  
  down_genes_z_score <- mean(all_values)

  loop_dataset <- data.frame(patient=i, norm_3e_z_score_down = down_genes_z_score)
  
  fake_down_dataset <- rbind(fake_down_dataset, loop_dataset)
}



```


Merge two datasets
```{r}
neg_ctrl_fake_patient_scores <- left_join(fake_up_dataset, fake_down_dataset, by="patient")

neg_ctrl_fake_patient_scores <- neg_ctrl_fake_patient_scores %>% 
  mutate(total_z_score = norm_3e_z_score_up - norm_3e_z_score_down)

```

NEG CONTROL - visualize scores among patient cohort
```{r}
ggplot(neg_ctrl_fake_patient_scores, aes(x=total_z_score))+
  geom_histogram(bins = 400)
```


Stratify into groups based on z score

```{r}

neg_ctrl_quantile_groups <- quantile(neg_ctrl_fake_patient_scores$total_z_score, probs=seq(0,1,.25), na.rm=TRUE)

neg_ctrl_fake_patient_scores$quantile <- cut(neg_ctrl_fake_patient_scores$total_z_score, breaks = quantile_groups, include.lowest = TRUE, labels = FALSE)

neg_ctrl_fake_patient_scores$patient <- gsub("\\.", "-", as.character(neg_ctrl_fake_patient_scores$patient))


colnames(neg_ctrl_fake_patient_scores) <- paste(colnames(neg_ctrl_fake_patient_scores),"neg_ctrl",sep="_") 

names(neg_ctrl_fake_patient_scores)[names(neg_ctrl_fake_patient_scores) == "patient_neg_ctrl"] <- "patient"




```


Now plot neg control!


```{r}
all_data <- left_join(clin, neg_ctrl_fake_patient_scores, by=c("PATIENT_ID"="patient"))


all_data <- all_data %>% 
  mutate(neg_ctrl_high_signature = ifelse(quantile_neg_ctrl==4, TRUE, FALSE))

all_data <- all_data %>% 
  mutate(neg_ctrl_low_signature = ifelse(quantile_neg_ctrl==1, TRUE, FALSE))
```


```{r}
clin2 <- all_data[c(which(all_data$neg_ctrl_low_signature), which(all_data$neg_ctrl_high_signature)),]
fit <- survfit(Surv(OS_YEARS, OS_STATUS) ~ neg_ctrl_low_signature, data = clin2)


ggsurvplot(fit, data = clin2, size = 1, palette = c("#E7B800", "#2E9FDF"),legend.labs = c("NEG CTRL eIF3e KD signature high", "NEG CTRL eIF3e KD signature low"),  break.time.by = 1, ylab="Overall Survival", xlab = "Time in years", xlim = c(0,10),conf.int = TRUE, pval = TRUE, risk.table = TRUE,  risk.table.col = "strata", risk.table.height = 0.25, ggtheme = theme_bw())

```



# What's the difference between the 3e and 3d normoxia signatures?

What is in 3e that's not in 3d?

```{r}

only_3e_norm_up <- up_3e_norm$symbol[up_3e_norm$symbol %in% up_3d_norm$symbol]

only_3e_norm_down <- down_3e_norm$symbol[down_3e_norm$symbol %in% down_3d_norm$symbol]

only_3e_norm_combined <- c(only_3e_norm_up, only_3e_norm_down)
```

# Over-representation analysis 


Set up cluster profiler over representation analysis

```{r}
organism <- "org.Hs.eg.db"
library(organism, character.only = TRUE)

```

also msigdbr
```{r}
hs_msigdb_df <- msigdbr(species = "Homo sapiens")
```

Need genes of interest with entrez ids


and universe background genes -- all genes expressed in 3e
Use enrichR function

```{r}
universe_3e <- all_sheets$normoxia_si3e$gene_id
```

Get genes
```{r}


entrez_vector <- mapIds(
  # Replace with annotation package for the organism relevant to your data
  org.Hs.eg.db,
  # The vector of gene identifiers we want to map
  keys = gene_ids_all,
  # Replace with the type of gene identifiers in your data
  keytype = "ENSEMBL",
  # Replace with the type of gene identifiers you would like to map to
  column = "ENTREZID",
  # In the case of 1:many mappings, return the
  # first one. This is default behavior!
  multiVals = "first"
)

gene_key_df <- data.frame(
  ensembl_id = names(entrez_vector),
  entrez_id = entrez_vector,
  stringsAsFactors = FALSE
) %>%
  # If an Ensembl gene identifier doesn't map to a gene symbol, drop that
  # from the data frame
  dplyr::filter(!is.na(entrez_id))




#make universe

universe <- rbind(sig_3e_norm, sig_3e_hyp, sig_3d_norm, sig_3d_hyp, sig_a209_norm, sig_a209_hyp)

universe$gene_id <- gsub("\\..*", "", as.character(universe$gene_id))

universe <- universe %>% 
  left_join(gene_key_df, by= c("gene_id"="ensembl_id"))

background_set <- unique(as.character(universe$entrez_id))




```

Join to my data before doing the analysis






up and down separate first
```{r}
#up
only_3e_up <- up_3e_norm %>% 
  filter(symbol %in% only_3e_norm_up)

# eif3e_only_up <- only_3e_up$log2FoldChange
# names(eif3e_only_up) <- only_3e_up$symbol
# eif3e_only_up <- sort(eif3e_only, decreasing = TRUE)

#down

only_3e_down <- down_3e_norm %>% 
  filter(symbol %in% only_3e_norm_down)

# eif3e_only_down <- only_3e_down$log2FoldChange
# names(eif3e_only_down) <- only_3e_down$symbol
# eif3e_only_down <- sort(eif3e_only, decreasing = TRUE)

#combined

only_3e_comb <-  sig_3e_norm %>% 
  filter(symbol %in% only_3e_norm_combined)

# eif3e_only_comb <- only_3e_comb$log2FoldChange
# names(eif3e_only_comb) <- only_3e_comb$symbol
# eif3e_only_comb <- sort(eif3e_only_comb, decreasing = TRUE)

#no need to sort


only_3e_comb$gene_id <- gsub("\\..*", "", as.character(only_3e_comb$gene_id))

only_3e_comb <- only_3e_comb %>% 
  left_join(gene_key_df, by=c("gene_id"="ensembl_id"))


```

# set up pathways to grab from

```{r}

m_df_h <- msigdbr(species = "Homo sapiens") %>%
  filter(gs_cat == "H") %>% 
  dplyr::select(gs_name, gene_symbol, entrez_gene)

m_df_c2 <- msigdbr(species = "Homo sapiens") %>%
  filter(gs_cat == "C2" & gs_subcat != "CGP") %>% 
  dplyr::select(gs_name, gene_symbol, entrez_gene)

hs_kegg_df <- hs_msigdb_df %>%
  dplyr::filter(
    gs_cat == "C2", # This is to filter only to the C2 curated gene sets
    gs_subcat == "CP:KEGG" # This is because we only want KEGG pathways
  )
```



nothing is coming up for the intersection of 3e and 3d genes. So now I'm going to separately look at the overlap for the 3e normoixa and 3d normoixa gene sets

and perhaps a209

```{r}

#3e
norm_3e_sig <- rbind(up_3e_norm, down_3e_norm)

norm_3e_sig$gene_id <- gsub("\\..*", "", as.character(norm_3e_sig$gene_id))

 norm_3e_sig_final <- norm_3e_sig%>% 
    left_join(gene_key_df, by=c("gene_id"="ensembl_id"))


#3d

norm_3d_sig <- rbind(up_3d_norm, down_3d_norm)

norm_3d_sig$gene_id <- gsub("\\..*", "", as.character(norm_3d_sig$gene_id))

norm_3d_sig_final <- norm_3d_sig %>%
  left_join(gene_key_df, by=c("gene_id"="ensembl_id"))

#a209
norm_a209_sig <- rbind(up_a209_norm, down_a209_norm)

norm_a209_sig$gene_id <- gsub("\\..*", "", as.character(norm_a209_sig$gene_id))

norm_a209_sig_final <- norm_a209_sig %>% 
    left_join(gene_key_df, by=c("gene_id"="ensembl_id"))

```

Now run ORA on each norm signature individually

C2

```{r}

#3e



c2_3e_ora_results <- enricher(
  gene = norm_3e_sig_final$entrez_id, # A vector of your genes of interest
  pvalueCutoff = .05, # Can choose a FDR cutoff
  pAdjustMethod = "BH", # Method to be used for multiple testing correction
  universe = background_set, # A vector containing your background set genes
  # The pathway information should be a data frame with a term name or
  # identifier and the gene identifiers
  TERM2GENE = dplyr::select(
    m_df_c2,
    gs_name,
    entrez_gene
  )
)


c2_3e_ora_results_df<-data.frame(c2_3e_ora_results@result) 

sig_c2_3e_ora_results_df <- c2_3e_ora_results_df %>% 
  filter(p.adjust < 0.05)

enrich_plot <- enrichplot::dotplot(c2_3e_ora_results)

enrich_plot


#3d



c2_3d_ora_results <- enricher(
  gene = norm_3d_sig_final$entrez_id, # A vector of your genes of interest
  pvalueCutoff = .05, # Can choose a FDR cutoff
  pAdjustMethod = "BH", # Method to be used for multiple testing correction
  universe = background_set, # A vector containing your background set genes
  # The pathway information should be a data frame with a term name or
  # identifier and the gene identifiers
  TERM2GENE = dplyr::select(
    m_df_c2,
    gs_name,
    entrez_gene
  )
)

c2_3d_ora_results_df<-data.frame(c2_3d_ora_results@result) 

sig_c2_3d_ora_results_df <- c2_3d_ora_results_df %>% 
  filter(p.adjust < 0.05)

enrich_plot <- enrichplot::dotplot(c2_3d_ora_results)

enrich_plot





#a209


c2_a209_ora_results <- enricher(
  gene = norm_a209_sig_final$entrez_id, # A vector of your genes of interest
  pvalueCutoff = .05, # Can choose a FDR cutoff
  pAdjustMethod = "BH", # Method to be used for multiple testing correction
  universe = background_set, # A vector containing your background set genes
  # The pathway information should be a data frame with a term name or
  # identifier and the gene identifiers
  TERM2GENE = dplyr::select(
    m_df_c2,
    gs_name,
    entrez_gene
  )
)


c2_a209_ora_results_df<-data.frame(c2_a209_ora_results@result) 

sig_c2_a209_ora_results_df <- c2_a209_ora_results_df %>% 
  filter(p.adjust < 0.05)

enrich_plot <- enrichplot::dotplot(c2_a209_ora_results)

enrich_plot








```




Same with hallmark


```{r}

#3e



h_3e_ora_results <- enricher(
  gene = norm_3e_sig_final$entrez_id, # A vector of your genes of interest
  pvalueCutoff = .05, # Can choose a FDR cutoff
  pAdjustMethod = "BH", # Method to be used for multiple testing correction
  universe = background_set, # A vector containing your background set genes
  # The pathway information should be a data frame with a term name or
  # identifier and the gene identifiers
  TERM2GENE = dplyr::select(
    m_df_h,
    gs_name,
    entrez_gene
  )
)


h_3e_ora_results_df<-data.frame(h_3e_ora_results@result) 

sig_h_3e_ora_results_df <- h_3e_ora_results_df %>% 
  filter(p.adjust < 0.05)

enrich_plot <- enrichplot::dotplot(h_3e_ora_results)

enrich_plot


#3d



h_3d_ora_results <- enricher(
  gene = norm_3d_sig_final$entrez_id, # A vector of your genes of interest
  pvalueCutoff = .05, # Can choose a FDR cutoff
  pAdjustMethod = "BH", # Method to be used for multiple testing correction
  universe = background_set, # A vector containing your background set genes
  # The pathway information should be a data frame with a term name or
  # identifier and the gene identifiers
  TERM2GENE = dplyr::select(
    m_df_h,
    gs_name,
    entrez_gene
  )
)

h_3d_ora_results_df<-data.frame(h_3d_ora_results@result) 

sig_h_3d_ora_results_df <- h_3d_ora_results_df %>% 
  filter(p.adjust < 0.05)

enrich_plot <- enrichplot::dotplot(h_3d_ora_results)

enrich_plot





#a209


h_a209_ora_results <- enricher(
  gene = norm_a209_sig_final$entrez_id, # A vector of your genes of interest
  pvalueCutoff = .05, # Can choose a FDR cutoff
  pAdjustMethod = "BH", # Method to be used for multiple testing correction
  universe = background_set, # A vector containing your background set genes
  # The pathway information should be a data frame with a term name or
  # identifier and the gene identifiers
  TERM2GENE = dplyr::select(
    m_df_h,
    gs_name,
    entrez_gene
  )
)


h_a209_ora_results_df<-data.frame(h_a209_ora_results@result) 

sig_h_a209_ora_results_df <- h_a209_ora_results_df %>% 
  filter(p.adjust < 0.05)

enrich_plot <- enrichplot::dotplot(h_a209_ora_results)

enrich_plot


#kegg




#3e



kegg_3e_ora_results <- enricher(
  gene = norm_3e_sig_final$entrez_id, # A vector of your genes of interest
  pvalueCutoff = .05, # Can choose a FDR cutoff
  pAdjustMethod = "BH", # Method to be used for multiple testing correction
  universe = background_set, # A vector containing your background set genes
  # The pathway information should be a data frame with a term name or
  # identifier and the gene identifiers
  TERM2GENE = dplyr::select(
    hs_kegg_df,
    gs_name,
    entrez_gene
  )
)


kegg_3e_ora_results_df<-data.frame(kegg_3e_ora_results@result) 

sig_kegg_3e_ora_results_df <- kegg_3e_ora_results_df %>% 
  filter(p.adjust < 0.05)

enrich_plot <- enrichplot::dotplot(kegg_3e_ora_results)

enrich_plot


#3d



kegg_3d_ora_results <- enricher(
  gene = norm_3d_sig_final$entrez_id, # A vector of your genes of interest
  pvalueCutoff = .05, # Can choose a FDR cutoff
  pAdjustMethod = "BH", # Method to be used for multiple testing correction
  universe = background_set, # A vector containing your background set genes
  # The pathway information should be a data frame with a term name or
  # identifier and the gene identifiers
  TERM2GENE = dplyr::select(
    hs_kegg_df,
    gs_name,
    entrez_gene
  )
)

kegg_3d_ora_results_df<-data.frame(kegg_3d_ora_results@result) 

sig_kegg_3d_ora_results_df <- kegg_3d_ora_results_df %>% 
  filter(p.adjust < 0.05)

enrich_plot <- enrichplot::dotplot(h_3d_ora_results)

enrich_plot





#a209


kegg_a209_ora_results <- enricher(
  gene = norm_a209_sig_final$entrez_id, # A vector of your genes of interest
  pvalueCutoff = .05, # Can choose a FDR cutoff
  pAdjustMethod = "BH", # Method to be used for multiple testing correction
  universe = background_set, # A vector containing your background set genes
  # The pathway information should be a data frame with a term name or
  # identifier and the gene identifiers
  TERM2GENE = dplyr::select(
    hs_kegg_df,
    gs_name,
    entrez_gene
  )
)


kegg_a209_ora_results_df<-data.frame(kegg_a209_ora_results@result) 

sig_kegg_a209_ora_results_df <- kegg_a209_ora_results_df %>% 
  filter(p.adjust < 0.05)

enrich_plot <- enrichplot::dotplot(kegg_a209_ora_results)

enrich_plot





```





Now, let's repeat the whole thing in hypoxia

```{r}

#set datasets

#3e
hyp_3e_sig <- rbind(up_3e_hyp, down_3e_hyp)

hyp_3e_sig$gene_id <- gsub("\\..*", "", as.character(hyp_3e_sig$gene_id))

 hyp_3e_sig_final <- hyp_3e_sig%>% 
    left_join(gene_key_df, by=c("gene_id"="ensembl_id"))


#3d

hyp_3d_sig <- rbind(up_3d_hyp, down_3d_hyp)

hyp_3d_sig$gene_id <- gsub("\\..*", "", as.character(hyp_3d_sig$gene_id))

hyp_3d_sig_final <- hyp_3d_sig %>%
  left_join(gene_key_df, by=c("gene_id"="ensembl_id"))

#a209
hyp_a209_sig <- rbind(up_a209_hyp, down_a209_hyp)

hyp_a209_sig$gene_id <- gsub("\\..*", "", as.character(hyp_a209_sig$gene_id))

hyp_a209_sig_final <- hyp_a209_sig %>% 
    left_join(gene_key_df, by=c("gene_id"="ensembl_id"))



# run ORA

#c2

#3e



c2_3e_ora_results_hyp <- enricher(
  gene = norm_3e_sig_final$entrez_id, # A vector of your genes of interest
  pvalueCutoff = .05, # Can choose a FDR cutoff
  pAdjustMethod = "BH", # Method to be used for multiple testing correction
  universe = background_set, # A vector containing your background set genes
  # The pathway information should be a data frame with a term name or
  # identifier and the gene identifiers
  TERM2GENE = dplyr::select(
    m_df_c2,
    gs_name,
    entrez_gene
  )
)


c2_3e_ora_results_hyp_df<-data.frame(c2_3e_ora_results_hyp@result) 

sig_c2_3e_ora_results_hyp_df <- c2_3e_ora_results_hyp_df %>% 
  filter(p.adjust < 0.05)

enrich_plot <- enrichplot::dotplot(c2_3e_ora_results_hyp)

enrich_plot


#3d



c2_3d_ora_results_hyp <- enricher(
  gene = hyp_3d_sig_final$entrez_id, # A vector of your genes of interest
  pvalueCutoff = .05, # Can choose a FDR cutoff
  pAdjustMethod = "BH", # Method to be used for multiple testing correction
  universe = background_set, # A vector containing your background set genes
  # The pathway information should be a data frame with a term name or
  # identifier and the gene identifiers
  TERM2GENE = dplyr::select(
    m_df_c2,
    gs_name,
    entrez_gene
  )
)

c2_3d_ora_results_hyp_df<-data.frame(c2_3d_ora_results_hyp@result) 

sig_c2_3d_ora_results_hyp_df <- c2_3d_ora_results_hyp_df %>% 
  filter(p.adjust < 0.05)

enrich_plot <- enrichplot::dotplot(c2_3d_ora_results_hyp)

enrich_plot





#a209


c2_a209_ora_results_hyp <- enricher(
  gene = hyp_a209_sig_final$entrez_id, # A vector of your genes of interest
  pvalueCutoff = .05, # Can choose a FDR cutoff
  pAdjustMethod = "BH", # Method to be used for multiple testing correction
  universe = background_set, # A vector containing your background set genes
  # The pathway information should be a data frame with a term name or
  # identifier and the gene identifiers
  TERM2GENE = dplyr::select(
    m_df_c2,
    gs_name,
    entrez_gene
  )
)


c2_a209_ora_results_hyp_df<-data.frame(c2_a209_ora_results_hyp@result) 

sig_c2_a209_ora_results_hyp_df <- c2_a209_ora_results_hyp_df %>% 
  filter(p.adjust < 0.05)

enrich_plot <- enrichplot::dotplot(c2_a209_ora_results_hyp)

enrich_plot






#### hallmark

#h

#3e



h_3e_ora_results_hyp <- enricher(
  gene = norm_3e_sig_final$entrez_id, # A vector of your genes of interest
  pvalueCutoff = .05, # Can choose a FDR cutoff
  pAdjustMethod = "BH", # Method to be used for multiple testing correction
  universe = background_set, # A vector containing your background set genes
  # The pathway information should be a data frame with a term name or
  # identifier and the gene identifiers
  TERM2GENE = dplyr::select(
    m_df_h,
    gs_name,
    entrez_gene
  )
)


h_3e_ora_results_hyp_df<-data.frame(h_3e_ora_results_hyp@result) 

sig_h_3e_ora_results_hyp_df <- h_3e_ora_results_hyp_df %>% 
  filter(p.adjust < 0.05)

enrich_plot <- enrichplot::dotplot(h_3e_ora_results_hyp)

enrich_plot


#3d



h_3d_ora_results_hyp <- enricher(
  gene = hyp_3d_sig_final$entrez_id, # A vector of your genes of interest
  pvalueCutoff = .05, # Can choose a FDR cutoff
  pAdjustMethod = "BH", # Method to be used for multiple testing correction
  universe = background_set, # A vector containing your background set genes
  # The pathway information should be a data frame with a term name or
  # identifier and the gene identifiers
  TERM2GENE = dplyr::select(
    m_df_h,
    gs_name,
    entrez_gene
  )
)

h_3d_ora_results_hyp_df<-data.frame(h_3d_ora_results_hyp@result) 

sig_h_3d_ora_results_hyp_df <- h_3d_ora_results_hyp_df %>% 
  filter(p.adjust < 0.05)

enrich_plot <- enrichplot::dotplot(h_3d_ora_results_hyp)

enrich_plot





#a209


h_a209_ora_results_hyp <- enricher(
  gene = hyp_a209_sig_final$entrez_id, # A vector of your genes of interest
  pvalueCutoff = .05, # Can choose a FDR cutoff
  pAdjustMethod = "BH", # Method to be used for multiple testing correction
  universe = background_set, # A vector containing your background set genes
  # The pathway information should be a data frame with a term name or
  # identifier and the gene identifiers
  TERM2GENE = dplyr::select(
    m_df_h,
    gs_name,
    entrez_gene
  )
)


h_a209_ora_results_hyp_df<-data.frame(h_a209_ora_results_hyp@result) 

sig_h_a209_ora_results_hyp_df <- h_a209_ora_results_hyp_df %>% 
  filter(p.adjust < 0.05)

enrich_plot <- enrichplot::dotplot(h_a209_ora_results_hyp)

enrich_plot









#kegg


#3e



kegg_3e_ora_results_hyp <- enricher(
  gene = norm_3e_sig_final$entrez_id, # A vector of your genes of interest
  pvalueCutoff = .05, # Can choose a FDR cutoff
  pAdjustMethod = "BH", # Method to be used for multiple testing correction
  universe = background_set, # A vector containing your background set genes
  # The pathway information should be a data frame with a term name or
  # identifier and the gene identifiers
  TERM2GENE = dplyr::select(
    hs_kegg_df,
    gs_name,
    entrez_gene
  )
)


kegg_3e_ora_results_hyp_df<-data.frame(kegg_3e_ora_results_hyp@result) 

sig_kegg_3e_ora_results_hyp_df <- kegg_3e_ora_results_hyp_df %>% 
  filter(p.adjust < 0.05)

enrich_plot <- enrichplot::dotplot(kegg_3e_ora_results_hyp)

enrich_plot


#3d



kegg_3d_ora_results_hyp <- enricher(
  gene = hyp_3d_sig_final$entrez_id, # A vector of your genes of interest
  pvalueCutoff = .05, # Can choose a FDR cutoff
  pAdjustMethod = "BH", # Method to be used for multiple testing correction
  universe = background_set, # A vector containing your background set genes
  # The pathway information should be a data frame with a term name or
  # identifier and the gene identifiers
  TERM2GENE = dplyr::select(
    hs_kegg_df,
    gs_name,
    entrez_gene
  )
)

kegg_3d_ora_results_hyp_df<-data.frame(kegg_3d_ora_results_hyp@result) 

sig_kegg_3d_ora_results_hyp_df <- kegg_3d_ora_results_hyp_df %>% 
  filter(p.adjust < 0.05)

enrich_plot <- enrichplot::dotplot(kegg_3d_ora_results_hyp)

enrich_plot





#a209


kegg_a209_ora_results_hyp <- enricher(
  gene = hyp_a209_sig_final$entrez_id, # A vector of your genes of interest
  pvalueCutoff = .05, # Can choose a FDR cutoff
  pAdjustMethod = "BH", # Method to be used for multiple testing correction
  universe = background_set, # A vector containing your background set genes
  # The pathway information should be a data frame with a term name or
  # identifier and the gene identifiers
  TERM2GENE = dplyr::select(
    hs_kegg_df,
    gs_name,
    entrez_gene
  )
)


kegg_a209_ora_results_hyp_df<-data.frame(kegg_a209_ora_results_hyp@result) 

sig_kegg_a209_ora_results_hyp_df <- kegg_a209_ora_results_hyp_df %>% 
  filter(p.adjust < 0.05)

enrich_plot <- enrichplot::dotplot(kegg_a209_ora_results_hyp)

enrich_plot






```



# Venn diagram of all RNAs changed



```{r}
#all_all_up
norm_rna_all_up <- list(
  all_up_3d_norm = all_up_3d_norm$symbol,
  all_up_3e_norm = all_up_3e_norm$symbol,
  all_up_a209_norm = all_up_a209_norm$symbol
)

venn_norm_all_up<- ggvenn(norm_rna_all_up, auto_scale = F, fill_color = c(si3d_col,si3e_col, a209_col))

print(venn_norm_all_up)


#down
norm_rna_all_down <- list(
  all_down_3d_norm = all_down_3d_norm$symbol,
  all_down_3e_norm = all_down_3e_norm$symbol,
  all_down_a209_norm = all_down_a209_norm$symbol
)

venn_norm_all_down<- ggvenn(norm_rna_all_down, auto_scale = F, fill_color = c(si3d_col,si3e_col, a209_col))

print(venn_norm_all_down)


# Hypoxia

#all_up
hyp_rna_all_up <- list(
  all_up_3d_hyp = all_up_3d_hyp$symbol,
  all_up_3e_hyp = all_up_3e_hyp$symbol,
  all_up_a209_hyp = all_up_a209_hyp$symbol
)

venn_hyp_all_up<- ggvenn(hyp_rna_all_up, auto_scale = F, fill_color = c(si3d_col,si3e_col, a209_col))

print(venn_hyp_all_up)


#all_down
hyp_rna_all_down <- list(
  all_down_3d_hyp = all_down_3d_hyp$symbol,
  all_down_3e_hyp = all_down_3e_hyp$symbol,
  all_down_a209_hyp = all_down_a209_hyp$symbol
)

venn_hyp_all_down<- ggvenn(hyp_rna_all_down, auto_scale = F, fill_color = c(si3d_col,si3e_col, a209_col))

print(venn_hyp_all_down)



```







# Venn diagram of signatures

```{r}
#up
norm_rna_up <- list(
  up_3d_norm = up_3d_norm$symbol,
  up_3e_norm = up_3e_norm$symbol,
  up_a209_norm = up_a209_norm$symbol
)

venn_norm_up<- ggvenn(norm_rna_up, auto_scale = F, fill_color = c(si3d_col,si3e_col, a209_col))

print(venn_norm_up)


#down
norm_rna_down <- list(
  down_3d_norm = down_3d_norm$symbol,
  down_3e_norm = down_3e_norm$symbol,
  down_a209_norm = down_a209_norm$symbol
)

venn_norm_down<- ggvenn(norm_rna_down, auto_scale = F, fill_color = c(si3d_col,si3e_col, a209_col))

print(venn_norm_down)


# Hypoxia

#up
hyp_rna_up <- list(
  up_3d_hyp = up_3d_hyp$symbol,
  up_3e_hyp = up_3e_hyp$symbol,
  up_a209_hyp = up_a209_hyp$symbol
)

venn_hyp_up<- ggvenn(hyp_rna_up, auto_scale = F, fill_color = c(si3d_col,si3e_col, a209_col))

print(venn_hyp_up)


#down
hyp_rna_down <- list(
  down_3d_hyp = down_3d_hyp$symbol,
  down_3e_hyp = down_3e_hyp$symbol,
  down_a209_hyp = down_a209_hyp$symbol
)

venn_hyp_down<- ggvenn(hyp_rna_down, auto_scale = F, fill_color = c(si3d_col,si3e_col, a209_col))

print(venn_hyp_down)



```

combine up and down

```{r}
hyp_overlap <- list(
  hyp_3e = hyp_3e_sig$gene_id,
  hyp_3d = hyp_3d_sig$gene_id,
  hyp_a209 = hyp_a209_sig$gene_id
)

venn_hyp<- ggvenn(hyp_overlap, auto_scale = F, fill_color = c(si3e_col,si3d_col, a209_col))

print(venn_hyp)
```


```{r}
norm_overlap <- list(
  norm_3e = norm_3e_sig$gene_id,
  norm_3d = norm_3d_sig$gene_id,
  norm_a209 = norm_a209_sig$gene_id
)

venn_norm<- ggvenn(norm_overlap, auto_scale = F, fill_color = c(si3e_col,si3d_col, a209_col))

print(venn_norm)
```

