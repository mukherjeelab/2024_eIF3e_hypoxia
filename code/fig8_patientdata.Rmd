---
title: "Figure 8 - reanalyzed"
author: "Kate"
date: "2024-08-27"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(here)
library(tidyverse)
library(janitor)
library(readxl)
library(cBioPortalData)
library(MetaIntegrator)
library(cbioportalR)
library(pheatmap)
library(cowplot)
library(ggpubr)
library(survival)
library(survminer)
library(GSVA)
library(GSEABase)
library(matrixStats)
library(clusterProfiler)
library(msigdbr)
library(GeneOverlap)
library(UpSetR)
library(ComplexHeatmap)
```

# Load RNA signatures - generated in fig 6 code

### 3e normoxia and hypoxia
```{r}

all_rna_3e_norm <- read_excel(here("counts/rna_signature_3e_normoxia.xlsx"))
rna_3e_norm <- read_excel(here("counts/rna_signature_3e_normoxia.xlsx")) %>% 
  filter(padj < 0.05)

up_3e_norm <- rna_3e_norm %>% 
  filter(log2FoldChange > 1)
  
tally(up_3e_norm)

down_3e_norm <- rna_3e_norm %>% 
  filter(log2FoldChange < -1)
  
tally(down_3e_norm)

sig_3e_norm <- rbind(up_3e_norm, down_3e_norm)

# 3e hypoxia
all_rna_3e_hyp<- read_excel(here("counts/rna_signature_3e_hypoxia.xlsx"))
rna_3e_hyp <- read_excel(here("counts/rna_signature_3e_hypoxia.xlsx")) %>% 
  filter(padj < 0.05)

up_3e_hyp <- rna_3e_hyp %>% 
  filter(log2FoldChange > 1)
  
tally(up_3e_hyp)

down_3e_hyp <- rna_3e_hyp %>% 
  filter(log2FoldChange < -1)
  
tally(down_3e_hyp)

sig_3e_hyp <- rbind(up_3e_hyp, down_3e_hyp)

```


### 3d normoxia and hypoxia
```{r}

all_rna_3d_norm <- read_excel(here("counts/rna_signature_3d_normoxia.xlsx"))
rna_3d_norm <- read_excel(here("counts/rna_signature_3d_normoxia.xlsx")) %>% 
  filter(padj < 0.05)

up_3d_norm <- rna_3d_norm %>% 
  filter(log2FoldChange > 1)
  
tally(up_3d_norm)

down_3d_norm <- rna_3d_norm %>% 
  filter(log2FoldChange < -1)
  
tally(down_3d_norm)

sig_3d_norm <- rbind(up_3d_norm, down_3d_norm)


# 3d hypoxia
all_rna_3d_hyp<- read_excel(here("counts/rna_signature_3d_hypoxia.xlsx"))
rna_3d_hyp <- read_excel(here("counts/rna_signature_3d_hypoxia.xlsx")) %>% 
  filter(padj < 0.05)

up_3d_hyp <- rna_3d_hyp %>% 
  filter(log2FoldChange > 1)
  
tally(up_3d_hyp)

down_3d_hyp <- rna_3d_hyp %>% 
  filter(log2FoldChange < -1)
  
tally(down_3d_hyp)

sig_3d_hyp <- rbind(up_3d_hyp, down_3d_hyp)

```

# Import METABRIC microarray data - read patient z scores and matching clinical data
```{r cache = TRUE}
zscores <- read.table(here("cbioportal_data/data_mrna_illumina_microarray_zscores_ref_diploid_samples.txt"), sep="\t", header=T)
row.names(zscores) <- gsub("_", ".",row.names(zscores))

# there are duplicates in this list. What happens when i subset for the genes we are interested in?

zscores_all_symbol <- zscores %>% 
  dplyr::select(-Entrez_Gene_Id)

### Average scores for duplicate patients
duplicated(zscores_all_symbol$Hugo_Symbol) %>% table()



merged_zscores_all <- zscores_all_symbol %>%
  group_by(Hugo_Symbol) %>%
  summarise(across(everything(), mean))


merged_zscores_matrix <- merged_zscores_all %>% 
  column_to_rownames("Hugo_Symbol") %>% 
  as.matrix()


```


# Assign to each patient a z score for the 3e normoxia signature

for loop generating z score for each patient

1. Create expression data
```{r}

exp <- merged_zscores_matrix %>%
  as.data.frame() %>% 
  rownames_to_column("Hugo_Symbol") %>% 
    filter(Hugo_Symbol %in% sig_3e_norm$symbol) %>% 
 column_to_rownames("Hugo_Symbol")


```



Assign a z score for each patient for 3e norm up values
#up values
```{r}
patients <- colnames(merged_zscores_all)
patients <- patients[patients !="Hugo_Symbol"]

up_3e_norm_dataset <- data.frame(patient=character(), avg_z_score=numeric(), stringsAsFactors = FALSE)

for (i in patients) {

  #filter dataframe
  patient_level <- exp %>% 
    dplyr::select(i) %>%
    rownames_to_column("Hugo_Symbol") %>% 
    filter(Hugo_Symbol %in% up_3e_norm$symbol)

    all_values <- as.vector(patient_level[,2])
  
  
  #geometric mean
  
  up_genes_z_score <- mean(all_values)

  loop_dataset <- data.frame(patient=i, norm_3e_z_score_up = up_genes_z_score)
  
  up_3e_norm_dataset <- rbind(up_3e_norm_dataset, loop_dataset)
}

ggplot(up_3e_norm_dataset, aes(x=norm_3e_z_score_up))+
  geom_histogram(bins = 400)

```
Plot distribution of values

#down values
```{r}

down_3e_norm_dataset <- data.frame(patient=character(), avg_z_score=numeric(), stringsAsFactors = FALSE)

for (i in patients) {

  #filter dataframe
  patient_level <- exp %>% 
    dplyr::select(i) %>%
    rownames_to_column("Hugo_Symbol") %>% 
    filter(Hugo_Symbol %in% down_3e_norm$symbol)

    all_values <- as.vector(patient_level[,2])
  
  
  #geometric mean
  
  down_genes_z_score <- mean(all_values)

  loop_dataset <- data.frame(patient=i, norm_3e_z_score_down = down_genes_z_score)
  
  down_3e_norm_dataset <- rbind(down_3e_norm_dataset, loop_dataset)
}

ggplot(down_3e_norm_dataset, aes(x=norm_3e_z_score_down))+
  geom_histogram(bins = 400)


```


Merge up and down z score and create a total z score value per patient
```{r}
patient_scores <- left_join(up_3e_norm_dataset, down_3e_norm_dataset, by="patient")

patient_scores <- patient_scores %>% 
  mutate(total_z_score = norm_3e_z_score_up - norm_3e_z_score_down)

```

Visualize total z scores
```{r}
ggplot(patient_scores, aes(x=total_z_score))+
  geom_histogram(bins = 400)
```


Stratify patients into quartiles for 3e norm signature based on z score

```{r}
quantile_groups <- quantile(patient_scores$total_z_score, probs=seq(0,1,.25), na.rm=TRUE)

patient_scores$quantile <- cut(patient_scores$total_z_score, breaks = quantile_groups, include.lowest = TRUE, labels = FALSE)

patient_scores$patient <- sub("-[^-]*$", "", patient_scores$patient)

```

### Read in patient meta data
Clinical data contains surival data
```{r}

clin <- read.table(here("cbioportal_data/data_clinical_patient.txt"), sep="\t", header=T)

# know this well

clin$OS_STATUS[which(clin$OS_STATUS == "1:DECEASED" & clin$OS_MONTHS > 120)] <- "0:LIVING"
clin <- cbind(clin, OS_YEARS = clin$OS_MONTHS/12)
clin$OS_YEARS[which(clin$OS_YEARS >= 10)] <- 10
dim(clin)


```

Bind clin data with patient z score data
```{r}

patient_scores$patient <- gsub("\\.", "-", patient_scores$patient)

all_data <- left_join(clin, patient_scores, by=c("PATIENT_ID"="patient"))

```

## eif3e signature vs survival
Visualize survival data by 3e normoxia signature expression

```{r}
fit_all <- survfit(Surv(OS_YEARS, OS_STATUS) ~ quantile, data = all_data)

coxfit <- coxph(Surv(OS_YEARS, OS_STATUS) ~ quantile, all_data)
summary(coxfit)

str(survfit(coxfit))

#report hazards ratio on plot

summary_coxfit <- summary(coxfit)

hr <- round(summary_coxfit$coefficients[1, "exp(coef)"], 2)
pval <- format.pval(summary_coxfit$coefficients[1, "Pr(>|z|)"], digits = 2, eps = 0.001)

```

```{r}

surv_plot <- ggsurvplot(fit_all, data = all_data, size = 1, palette = c("#E7B800", "pink", "purple", "#2E9FDF"),break.time.by = 1, ylab="Overall Survival", xlab = "Time in years", xlim = c(0,10),conf.int = TRUE, pval = FALSE, risk.table = FALSE,  risk.table.col = "strata", risk.table.height = 0.25, ggtheme = theme_bw())



surv_plot$plot <- surv_plot$plot + 
  annotate(
    "text", 
    x = 3, y = 0.2, 
    label = paste("HR =", hr, "\np =", pval), 
    size = 5, 
    color = "black"
  )+
  theme(text = element_text(size = 14))+
  ggtitle("Patient quatiles by eIF3e normoxia signature")

surv_plot

ggsave("3e_normoxia_surv_plot.pdf", path=here("plots"),width = 11.5, height=8)





ggplot(all_data, aes(x=quantile,y=total_z_score, group=quantile)) +
  geom_boxplot()+
  theme_cowplot()+
  ggtitle("Patient scores for eIF3e normoxia signature")

ggsave("3e norm boxplot.pdf",  path=here("plots"), width=4.5, height=4)






```

Plot just upper and lower quartiles

# eIF3e Hypoxia signature with survival

```{r}
# For loop generating z score for each patient

#expression matrix changes based on signature

exp <- merged_zscores_matrix %>%
  as.data.frame() %>% 
  rownames_to_column("Hugo_Symbol") %>% 
  filter(Hugo_Symbol %in% sig_3e_hyp$symbol) %>% 
  column_to_rownames("Hugo_Symbol")

# up loop

up_3e_hyp_dataset <- data.frame(patient=character(), avg_z_score=numeric(), stringsAsFactors = FALSE)

for (i in patients) {
  
  #filter dataframe
  patient_level <- exp %>% 
    dplyr::select(i) %>%
    rownames_to_column("Hugo_Symbol") %>% 
    filter(Hugo_Symbol %in% up_3e_hyp$symbol)
  
  all_values <- as.vector(patient_level[,2])
  
  
  #geometric mean
  
  up_genes_z_score <- mean(all_values, na.rm=TRUE)
  
  loop_dataset <- data.frame(patient=i, hyp_3e_z_score_up = up_genes_z_score)
  
  up_3e_hyp_dataset <- rbind(up_3e_hyp_dataset, loop_dataset)
}

ggplot(up_3e_hyp_dataset, aes(x=hyp_3e_z_score_up))+
  geom_histogram(bins = 400)


# down loop

down_3e_hyp_dataset <- data.frame(patient=character(), avg_z_score=numeric(), stringsAsFactors = FALSE)

for (i in patients) {
  
  #filter dataframe
  patient_level <- exp %>% 
    dplyr::select(i) %>%
    rownames_to_column("Hugo_Symbol") %>% 
    filter(Hugo_Symbol %in% down_3e_hyp$symbol)
  
  all_values <- as.vector(patient_level[,2])
  
  
  #geometric mean
  
  down_genes_z_score <- mean(all_values, na.rm=TRUE)
  
  loop_dataset <- data.frame(patient=i, hyp_3e_z_score_down = down_genes_z_score)
  
  down_3e_hyp_dataset <- rbind(down_3e_hyp_dataset, loop_dataset)
}

ggplot(down_3e_hyp_dataset, aes(x=hyp_3e_z_score_down))+
  geom_histogram(bins = 400)


# merge datasets

hyp_3e_patient_scores <- left_join(up_3e_hyp_dataset, down_3e_hyp_dataset, by="patient")

hyp_3e_patient_scores <- hyp_3e_patient_scores %>% 
  mutate(total_z_score = hyp_3e_z_score_up - hyp_3e_z_score_down)

#visualize distribution

ggplot(hyp_3e_patient_scores, aes(x=total_z_score))+
  geom_histogram(bins = 400)



### Stratify based on z-score

quantile_groups <- quantile(hyp_3e_patient_scores$total_z_score, probs=seq(0,1,.25), na.rm=TRUE)

hyp_3e_patient_scores$quantile <- cut(hyp_3e_patient_scores$total_z_score, breaks = quantile_groups, include.lowest = TRUE, labels = FALSE)

class(hyp_3e_patient_scores$patient)
class(clin$PATIENT_ID)

hyp_3e_patient_scores$patient %in% clin

hyp_3e_patient_scores$patient <- gsub("\\.", "-", hyp_3e_patient_scores$patient)


#bind clin data with z score



all_data_3e_hyp <- left_join(clin, hyp_3e_patient_scores, by=c("PATIENT_ID"="patient"))


#plot

fit_all_3e_hyp <- survfit(Surv(OS_YEARS, OS_STATUS) ~ quantile, data = all_data_3e_hyp)


coxfit <- coxph(Surv(OS_YEARS, OS_STATUS) ~ quantile, all_data_3e_hyp)
summary_coxfit_3e_norm <- summary(coxfit)


hr <- round(summary_coxfit_3e_norm$coefficients[1, "exp(coef)"], 2)
pval <- format.pval(summary_coxfit_3e_norm$coefficients[1, "Pr(>|z|)"], digits = 2, eps = 0.001)

surv_plot_3e_hyp <- ggsurvplot(fit_all_3e_hyp, data = all_data_3e_hyp, size = 1, palette = c("#E7B800", "pink", "purple", "#2E9FDF"),legend.labs = c("depleted for eIF3e signature (hypoxia): low (Q1)","depleted: medium-low (Q2)", "enriched: medium-high (Q3)", "enriched for eIF3e signature (hypoxia): high (Q4)"),  break.time.by = 1, ylab="Overall Survival", xlab = "Time in years", xlim = c(0,10),conf.int = TRUE, pval = FALSE, risk.table = FALSE,  risk.table.col = NA, risk.table.height = 0.25, ggtheme = theme_bw())

surv_plot_3e_hyp <- ggsurvplot(fit_all_3e_hyp, data = all_data_3e_hyp, size = 1, palette = c("#E7B800", "pink", "purple", "#2E9FDF"),  break.time.by = 1, ylab="Overall Survival", xlab = "Time in years", xlim = c(0,10),conf.int = TRUE, pval = FALSE, risk.table = FALSE,  risk.table.col = NA, risk.table.height = 0.25, ggtheme = theme_bw())



surv_plot_3e_hyp$plot <- surv_plot_3e_hyp$plot + 
  annotate(
    "text", 
    x = 3, y = 0.2, 
    label = paste("HR =", hr, "\np =", pval), 
    size = 5, 
    color = "black"
  )+
  theme(text = element_text(size = 14))+
  ggtitle("Patient quartiles by eIF3e hypoxia signature")

surv_plot_3e_hyp

ggsave("3e_hyp_surv_plot.pdf", path=here("plots"),width = 11.5, height=8)



#boxplot of quartile expression

ggplot(all_data_3e_hyp, aes(x=quantile,y=total_z_score, group=quantile)) +
  geom_boxplot()+
  theme_cowplot()+
  ggtitle("Patient scores for eIF3e hypoxia signature")

```







# eIF3d
### Hypoxia

```{r}

#expression matrix

exp <- merged_zscores_matrix %>%
  as.data.frame() %>% 
  rownames_to_column("Hugo_Symbol") %>% 
  filter(Hugo_Symbol %in% sig_3d_hyp$symbol) %>% 
  column_to_rownames("Hugo_Symbol")

# up loop

patients <- colnames(merged_zscores_all)
patients <- patients[patients !="Hugo_Symbol"]


up_3d_hyp_dataset <- data.frame(patient=character(), avg_z_score=numeric(), stringsAsFactors = FALSE)

for (i in patients) {
  
  #filter dataframe
  patient_level <- exp %>% 
    dplyr::select(i) %>%
    rownames_to_column("Hugo_Symbol") %>% 
    filter(Hugo_Symbol %in% up_3d_hyp$symbol)
  
  all_values <- as.vector(patient_level[,2])
  
  
  #geometric mean
  
  up_genes_z_score <- mean(all_values)
  
  loop_dataset <- data.frame(patient=i, hyp_3d_z_score_up = up_genes_z_score)
  
  up_3d_hyp_dataset <- rbind(up_3d_hyp_dataset, loop_dataset)
}

ggplot(up_3d_hyp_dataset, aes(x=hyp_3d_z_score_up))+
  geom_histogram(bins = 400)


# down loop

down_3d_hyp_dataset <- data.frame(patient=character(), avg_z_score=numeric(), stringsAsFactors = FALSE)

for (i in patients) {
  
  #filter dataframe
  patient_level <- exp %>% 
    dplyr::select(i) %>%
    rownames_to_column("Hugo_Symbol") %>% 
    filter(Hugo_Symbol %in% down_3d_hyp$symbol)
  
  all_values <- as.vector(patient_level[,2])
  
  
  #geometric mean
  
  down_genes_z_score <- mean(all_values)
  
  loop_dataset <- data.frame(patient=i, hyp_3d_z_score_down = down_genes_z_score)
  
  down_3d_hyp_dataset <- rbind(down_3d_hyp_dataset, loop_dataset)
}

ggplot(down_3d_hyp_dataset, aes(x=hyp_3d_z_score_down))+
  geom_histogram(bins = 400)

# merge datasets

hyp_3d_patient_scores <- left_join(up_3d_hyp_dataset, down_3d_hyp_dataset, by="patient")

hyp_3d_patient_scores <- hyp_3d_patient_scores %>% 
  mutate(total_z_score = hyp_3d_z_score_up - hyp_3d_z_score_down)

#visualize distribution

ggplot(hyp_3d_patient_scores, aes(x=total_z_score))+
  geom_histogram(bins = 400)



### Stratify based on z-score

quantile_groups <- quantile(hyp_3d_patient_scores$total_z_score, probs=seq(0,1,.25), na.rm=TRUE)

hyp_3d_patient_scores$quantile <- cut(hyp_3d_patient_scores$total_z_score, breaks = quantile_groups, include.lowest = TRUE, labels = FALSE)

hyp_3d_patient_scores$patient <- gsub("\\.", "-", as.character(hyp_3d_patient_scores$patient))


#bind clin data with z score

all_data_3d_hyp <- left_join(clin, hyp_3d_patient_scores, by=c("PATIENT_ID"="patient"))


#plot

fit_all_3d_hyp <- survfit(Surv(OS_YEARS, OS_STATUS) ~ quantile, data = all_data_3d_hyp)


coxfit <- coxph(Surv(OS_YEARS, OS_STATUS) ~ quantile, all_data_3d_hyp)
summary_coxfit_3d_norm <- summary(coxfit)


hr <- round(summary_coxfit_3d_norm$coefficients[1, "exp(coef)"], 2)
pval <- format.pval(summary_coxfit_3d_norm$coefficients[1, "Pr(>|z|)"], digits = 2, eps = 0.001)

surv_plot_3d_hyp <- ggsurvplot(fit_all_3d_hyp, data = all_data_3d_hyp, size = 1, palette = c("#E7B800", "pink", "purple", "#2E9FDF"),  break.time.by = 1, ylab="Overall Survival", xlab = "Time in years", xlim = c(0,10),conf.int = TRUE, pval = FALSE, risk.table = FALSE,  risk.table.col = "strata", risk.table.height = 0.25, ggtheme = theme_bw())



surv_plot_3d_hyp$plot <- surv_plot_3d_hyp$plot + 
  annotate(
    "text", 
    x = 3, y = 0.2, 
    label = paste("HR =", hr, "\np =", pval), 
    size = 5, 
    color = "black"
  )+
  theme(text = element_text(size = 14))+
  ggtitle("Patient quartiles by eIF3d hypoxia signature")

surv_plot_3d_hyp

ggsave("3d_hyp_surv_plot.pdf", path=here("plots"),width = 11.5, height=8)



#boxplot of quartile expression

ggplot(all_data_3d_hyp, aes(x=quantile,y=total_z_score, group=quantile)) +
  geom_boxplot()+
  theme_cowplot()+
  ggtitle("Patient scores for eIF3d hypoxia signature")

ggsave("3d hyp boxplot.pdf",  path=here("plots"), width=4.5, height=4)


```



# eIF3d
### normoxia

```{r}

#expression matrix

exp <- merged_zscores_matrix %>%
  as.data.frame() %>% 
  rownames_to_column("Hugo_Symbol") %>% 
  filter(Hugo_Symbol %in% sig_3d_norm$symbol) %>% 
  column_to_rownames("Hugo_Symbol")

# up loop

patients <- colnames(merged_zscores_all)
patients <- patients[patients !="Hugo_Symbol"]


up_3d_norm_dataset <- data.frame(patient=character(), avg_z_score=numeric(), stringsAsFactors = FALSE)

for (i in patients) {
  
  #filter dataframe
  patient_level <- exp %>% 
    dplyr::select(i) %>%
    rownames_to_column("Hugo_Symbol") %>% 
    filter(Hugo_Symbol %in% up_3d_norm$symbol)
  
  all_values <- as.vector(patient_level[,2])
  
  
  #geometric mean
  
  up_genes_z_score <- mean(all_values)
  
  loop_dataset <- data.frame(patient=i, norm_3d_z_score_up = up_genes_z_score)
  
  up_3d_norm_dataset <- rbind(up_3d_norm_dataset, loop_dataset)
}

ggplot(up_3d_norm_dataset, aes(x=norm_3d_z_score_up))+
  geom_histogram(bins = 400)


# down loop

down_3d_norm_dataset <- data.frame(patient=character(), avg_z_score=numeric(), stringsAsFactors = FALSE)

for (i in patients) {
  
  #filter dataframe
  patient_level <- exp %>% 
    dplyr::select(i) %>%
    rownames_to_column("Hugo_Symbol") %>% 
    filter(Hugo_Symbol %in% down_3d_norm$symbol)
  
  all_values <- as.vector(patient_level[,2])
  
  
  #geometric mean
  
  down_genes_z_score <- mean(all_values)
  
  loop_dataset <- data.frame(patient=i, norm_3d_z_score_down = down_genes_z_score)
  
  down_3d_norm_dataset <- rbind(down_3d_norm_dataset, loop_dataset)
}

ggplot(down_3d_norm_dataset, aes(x=norm_3d_z_score_down))+
  geom_histogram(bins = 400)


# merge datasets

norm_3d_patient_scores <- left_join(up_3d_norm_dataset, down_3d_norm_dataset, by="patient")

norm_3d_patient_scores <- norm_3d_patient_scores %>% 
  mutate(total_z_score = norm_3d_z_score_up - norm_3d_z_score_down)

#visualize distribution

ggplot(norm_3d_patient_scores, aes(x=total_z_score))+
  geom_histogram(bins = 400)



### Stratify based on z-score

quantile_groups <- quantile(norm_3d_patient_scores$total_z_score, probs=seq(0,1,.25), na.rm=TRUE)

norm_3d_patient_scores$quantile <- cut(norm_3d_patient_scores$total_z_score, breaks = quantile_groups, include.lowest = TRUE, labels = FALSE)

norm_3d_patient_scores$patient <- gsub("\\.", "-", as.character(norm_3d_patient_scores$patient))


#bind clin data with z score

all_data_3d_norm <- left_join(clin, norm_3d_patient_scores, by=c("PATIENT_ID"="patient"))


#plot

fit_all_3d_norm <- survfit(Surv(OS_YEARS, OS_STATUS) ~ quantile, data = all_data_3d_norm)


coxfit <- coxph(Surv(OS_YEARS, OS_STATUS) ~ quantile, all_data_3d_norm)
summary_coxfit_3d_norm <- summary(coxfit)


hr <- round(summary_coxfit_3d_norm$coefficients[1, "exp(coef)"], 2)
pval <- format.pval(summary_coxfit_3d_norm$coefficients[1, "Pr(>|z|)"], digits = 2, eps = 0.001)

surv_plot_3d_norm <- ggsurvplot(fit_all_3d_norm, data = all_data_3d_norm, size = 1, palette = c("#E7B800", "pink", "purple", "#2E9FDF"),  break.time.by = 1, ylab="Overall Survival", xlab = "Time in years", xlim = c(0,10),conf.int = TRUE, pval = FALSE, risk.table = FALSE,  risk.table.col = "strata", risk.table.height = 0.25, ggtheme = theme_bw())



surv_plot_3d_norm$plot <- surv_plot_3d_norm$plot + 
  annotate(
    "text", 
    x = 3, y = 0.2, 
    label = paste("HR =", hr, "\np =", pval), 
    size = 5, 
    color = "black"
  )+
  theme(text = element_text(size = 14))+
  ggtitle("Patient quartiles by eIF3d normoxia signature")

surv_plot_3d_norm

ggsave("3d_norm_surv_plot.pdf", path=here("plots"),width = 11.5, height=8)


ggplot(all_data_3d_norm, aes(x=quantile,y=total_z_score, group=quantile)) +
  geom_boxplot()+
  theme_cowplot()+
  ggtitle("Patient scores for eIF3d normoxia signature")

ggsave("3d norm boxplot.pdf",  path=here("plots"), width=4.5, height=4)




```

Hypoxia signature in breast cancer from ye et al
https://www.ncbi.nlm.nih.gov/pmc/articles/PMC6279594/#:~:text=The%2042%2Dgene%20expression%20signature,mediate%20the%20conserved%20hypoxic%20response

```{r}
ye_hyp_sig <- read_excel(here("other_data/hypoxic_sig_ye.xlsx"))

#these are only up values-- so give z score values here


exp <- merged_zscores_matrix %>%
  as.data.frame() %>% 
  rownames_to_column("Hugo_Symbol") %>% 
  filter(Hugo_Symbol %in% ye_hyp_sig$up_in_hypoxia) %>% 
  column_to_rownames("Hugo_Symbol")

# up loop

patients <- colnames(merged_zscores_all)
patients <- patients[patients !="Hugo_Symbol"]



ye_hyp_sig$up_in_hypoxia %in% rownames(exp)



ye_hif_dataset <- data.frame(patient=character(), avg_z_score=numeric(), stringsAsFactors = FALSE)

for (i in patients) {
  
  #filter dataframe
  patient_level <- exp %>% 
    dplyr::select(i) %>%
    rownames_to_column("Hugo_Symbol") %>% 
    filter(Hugo_Symbol %in% ye_hyp_sig$up_in_hypoxia)
  
  all_values <- as.vector(patient_level[,2])
  
  
  #geometric mean
  
  up_genes_z_score <- mean(all_values, na.rm=TRUE)
  
  loop_dataset <- data.frame(patient=i, ye_hyp_sig_up = up_genes_z_score)
  
  ye_hif_dataset <- rbind(ye_hif_dataset, loop_dataset)
}

#plot distribution
ggplot(ye_hif_dataset, aes(x=ye_hyp_sig_up))+
  geom_histogram(bins = 400)


ye_hif_dataset$patient <- gsub("\\.", "-", as.character(ye_hif_dataset$patient))


### Stratify based on z-score

quantile_groups <- quantile(ye_hif_dataset$ye_hyp_sig_up, probs=seq(0,1,.25), na.rm=TRUE)

ye_hif_dataset$quantile <- cut(ye_hif_dataset$ye_hyp_sig_up, breaks = quantile_groups, include.lowest = TRUE, labels = FALSE)

ye_hif_dataset$patient <- gsub("\\.", "-", as.character(ye_hif_dataset$patient))


#bind clin data with z score

all_data_hif_ye <- left_join(clin, ye_hif_dataset, by=c("PATIENT_ID"="patient"))


#plot

fit_all_data_hif_ye <- survfit(Surv(OS_YEARS, OS_STATUS) ~ quantile, data = all_data_hif_ye)


coxfit <- coxph(Surv(OS_YEARS, OS_STATUS) ~ quantile, all_data_hif_ye)
summary_coxfit_ye <- summary(coxfit)


hr <- round(summary_coxfit_ye$coefficients[1, "exp(coef)"], 2)
pval <- format.pval(summary_coxfit_ye$coefficients[1, "Pr(>|z|)"], digits = 2, eps = 0.001)

surv_plot_ye <- ggsurvplot(fit_all_data_hif_ye, data = all_data_hif_ye, size = 1, palette = c("#E7B800", "pink", "purple", "#2E9FDF"), break.time.by = 1, ylab="Overall Survival", xlab = "Time in years", xlim = c(0,10),conf.int = TRUE, pval = FALSE, risk.table = FALSE,  risk.table.col = "strata", risk.table.height = 0.25, ggtheme = theme_bw())



surv_plot_ye$plot <- surv_plot_ye$plot + 
  annotate(
    "text", 
    x = 3, y = 0.2, 
    label = paste("HR =", hr, "\np =", pval), 
    size = 5, 
    color = "black"
  ) + theme(text = element_text(size = 14))

surv_plot_ye

ggsave("surv_plot_ye.pdf", path=here("plots"),width = 11.5, height=8)





ggplot(all_data_hif_ye, aes(x=quantile,y=ye_hyp_sig_up, group=quantile)) +
  geom_boxplot()+
  theme_cowplot()+
  ggtitle("Patient scores for Ye et al hypoxia signature")

ggsave("ye hyp boxplot.pdf",  path=here("plots"), width=4.5, height=4)




```


See if correlated with our sigs


#plot 3e score against ye hypoxia score

```{r}

patient_ye_and_3e <- left_join(patient_scores, ye_hif_dataset, by="patient")

ggplot(patient_ye_and_3e, aes(x=ye_hyp_sig_up, y= total_z_score))+
  geom_point()+
  xlab("Ye Hypoxia z score")+
  ylab("eIF3e (normoxia) z score")+
  theme_cowplot()+ 
  theme(text = element_text(size = 14))


ggsave("3e_hyp_and_ye.pdf", path=here("plots"),width = 4, height=3)




cor.test(patient_ye_and_3e$ye_hyp_sig_up, patient_ye_and_3e$total_z_score)
```


# now try for hypoxia 3e

```{r}

patient_ye_and_3e_hyp <- left_join(hyp_3e_patient_scores, ye_hif_dataset, by="patient")

ggplot(patient_ye_and_3e_hyp, aes(x=ye_hyp_sig_up, y= total_z_score))+
  geom_point()+
  xlab("Ye Hypoxia z score")+
  ylab("eIF3e (hypoxia) z score")+
  theme_cowplot() +
  geom_hline(yintercept = 0) +
  geom_vline(xintercept = 0)+
  theme(text = element_text(size = 14))


ggsave("3e_hyp_and_ye.pdf", path=here("plots"),width = 5, height=4)

# remove z scores less than 0.2, 0.2

patient_ye_and_3e_hyp <- patient_ye_and_3e_hyp %>% 
  mutate(change = ifelse(abs(total_z_score) < 0.1 & abs(ye_hyp_sig_up) < 0.1, "small_change", "big_change"))




cor.test(patient_ye_and_3e_hyp$ye_hyp_sig_up, patient_ye_and_3e_hyp$total_z_score)
```

Make four groups based on quandrants
```{r}

patient_ye_and_3e_hyp <- patient_ye_and_3e_hyp %>% 
  mutate(quadrant = ifelse(ye_hyp_sig_up < 0 & total_z_score < 0, "low hypoxia and low eIF3e (hypoxia)",
                           ifelse(ye_hyp_sig_up > 0 & total_z_score < 0, "high hypoxia and low eIF3e (hypoxia)",
                                  ifelse(ye_hyp_sig_up > 0 & total_z_score > 0, "high hypoxia and high eIF3e (hypoxia)",
                                         ifelse(ye_hyp_sig_up < 0 & total_z_score > 0, "low hypoxia sig and high eIF3e (hypoxia)", "other")))))



```

Plot survival curve
```{r}
#bind with clin data
patient_ye_and_3e_hyp_clin <- left_join(clin, patient_ye_and_3e_hyp, by=c("PATIENT_ID"="patient"))


#plot

fit_all_hypoxia <- survfit(Surv(OS_YEARS, OS_STATUS) ~ quadrant, data = patient_ye_and_3e_hyp_clin)


coxfit <- coxph(Surv(OS_YEARS, OS_STATUS) ~ quadrant, patient_ye_and_3e_hyp_clin)
summary_coxfit <- summary(coxfit)


hr <- round(summary_coxfit$coefficients[1, "exp(coef)"], 2)
pval <- format.pval(summary_coxfit$coefficients[1, "Pr(>|z|)"], digits = 2, eps = 0.001)

patient_ye_and_3e_hyp_clin$quadrant <- as.factor(patient_ye_and_3e_hyp_clin$quadrant)

quadrant_levels <- levels(patient_ye_and_3e_hyp_clin$quadrant)


surv_plot <- ggsurvplot(fit_all_hypoxia, data = patient_ye_and_3e_hyp_clin, size = 1, palette = c("#E7B800", "pink", "purple", "#2E9FDF"),legend.labs = quadrant_levels,  break.time.by = 1, ylab="Overall Survival", xlab = "Time in years", xlim = c(0,10),conf.int = TRUE, pval = FALSE, risk.table = FALSE,  risk.table.col = "strata", risk.table.height = 0.25, ggtheme = theme_bw())



surv_plot$plot <- surv_plot$plot + 
  annotate(
    "text", 
    x = 3, y = 0.2, 
    label = paste("HR =", hr, "\np =", pval), 
    size = 5, 
    color = "black"
  )+ theme(text = element_text(size = 14))+
  ggtitle("Ye et al hypoxia signature and eIF3e hypoxia signature vs survival")

surv_plot

ggsave("surv_plot_3e_hyp_ye.pdf", path=here("plots"),width = 11.5, height=8)







```


Control: excluding points in the middle as a negative control for the survival curve analysis
```{r}

big_changes_hyp <- patient_ye_and_3e_hyp %>% 
  filter(change=="big_change")

ggplot(big_changes_hyp, aes(x=ye_hyp_sig_up, y= total_z_score))+
  geom_point()+
  xlab("Ye Hypoxia z score")+
  ylab("eIF3e (hypoxia) z score")+
  theme_cowplot() +
  geom_hline(yintercept = 0) +
  geom_vline(xintercept = 0)+
  theme(text = element_text(size = 14))

# ggsave("3e_hyp_and_ye_big_changes.pdf", path=here("plots"),width = 5, height=4)

cor.test(big_changes_hyp$ye_hyp_sig_up, big_changes_hyp$total_z_score)


# make four groups

big_changes_hyp <- big_changes_hyp %>% 
  mutate(quadrant = ifelse(ye_hyp_sig_up < 0 & total_z_score < 0, "depleted hypoxia sig and depleted eIF3e (hypoxia) sig",
                           ifelse(ye_hyp_sig_up > 0 & total_z_score < 0, "enriched hypoxia sig and depleted eIF3e (hypoxia) sig",
                                  ifelse(ye_hyp_sig_up > 0 & total_z_score > 0, "enriched hypoxia sig and enriched eIF3e (hypoxia) sig",
                                         ifelse(ye_hyp_sig_up < 0 & total_z_score > 0, "depleted hypoxia sig and enriched eIF3e (hypoxia) sig", "other")))))


# plot surival curve with those groups

#bind with clin data
patient_ye_and_3e_hyp_clin_big_changes <- left_join(clin, big_changes_hyp, by=c("PATIENT_ID"="patient"))


#plot

fit_all_hypoxia <- survfit(Surv(OS_YEARS, OS_STATUS) ~ quadrant, data = patient_ye_and_3e_hyp_clin_big_changes)


coxfit <- coxph(Surv(OS_YEARS, OS_STATUS) ~ quadrant, patient_ye_and_3e_hyp_clin_big_changes)
summary_coxfit <- summary(coxfit)


hr <- round(summary_coxfit$coefficients[1, "exp(coef)"], 2)
pval <- format.pval(summary_coxfit$coefficients[1, "Pr(>|z|)"], digits = 2, eps = 0.001)

patient_ye_and_3e_hyp_clin$quadrant <- as.factor(patient_ye_and_3e_hyp_clin_big_changes$quadrant)

quadrant_levels <- levels(patient_ye_and_3e_hyp_clin_big_changes$quadrant)


surv_plot <- ggsurvplot(fit_all_hypoxia, data = patient_ye_and_3e_hyp_clin, size = 1, palette = c("#E7B800", "pink", "purple", "#2E9FDF"),legend.labs = quadrant_levels,  break.time.by = 1, ylab="Overall Survival", xlab = "Time in years", xlim = c(0,10),conf.int = TRUE, pval = FALSE, risk.table = FALSE,  risk.table.col = "strata", risk.table.height = 0.25, ggtheme = theme_bw())



surv_plot$plot <- surv_plot$plot + 
  annotate(
    "text", 
    x = 3, y = 0.2, 
    label = paste("HR =", hr, "\np =", pval), 
    size = 5, 
    color = "black"
  )+ theme(text = element_text(size = 14))

surv_plot

ggsave("surv_plot_3e_hyp_ye_big changes.pdf", path=here("plots"),width = 11.5, height=8)










```


Control: Limit to changes over 0.1 as a control
```{r}
big_changes_hyp <- patient_ye_and_a209_hyp %>% 
  filter(change=="big_change")

ggplot(big_changes_hyp, aes(x=ye_hyp_sig_up, y= total_z_score))+
  geom_point()+
  xlab("Ye Hypoxia z score")+
  ylab("a209 (hypoxia) z score")+
  theme_cowplot() +
  geom_hline(yintercept = 0) +
  geom_vline(xintercept = 0)+
  theme(text = element_text(size = 14))

ggsave("a209_hyp_and_ye_big_changes.pdf", path=here("plots"),width = 5, height=4)


cor.test(big_changes_hyp$ye_hyp_sig_up, big_changes_hyp$total_z_score)


# make four groups
big_changes_hyp <- big_changes_hyp %>% 
  mutate(quadrant = ifelse(ye_hyp_sig_up < 0 & total_z_score < 0, "depleted hypoxia sig and depleted a209 (hypoxia) sig",
                           ifelse(ye_hyp_sig_up > 0 & total_z_score < 0, "enriched hypoxia sig and depleted a209 (hypoxia) sig",
                                  ifelse(ye_hyp_sig_up > 0 & total_z_score > 0, "enriched hypoxia sig and enriched a209 (hypoxia) sig",
                                         ifelse(ye_hyp_sig_up < 0 & total_z_score > 0, "depleted hypoxia sig and enriched a209 (hypoxia) sig", "other")))))




# plot surival curve with those groups
#bind with clin data
patient_ye_and_a209_hyp_clin <- left_join(clin, big_changes_hyp, by=c("PATIENT_ID"="patient"))


#plot

fit_all_hypoxia <- survfit(Surv(OS_YEARS, OS_STATUS) ~ quadrant, data = patient_ye_and_a209_hyp_clin)


coxfit <- coxph(Surv(OS_YEARS, OS_STATUS) ~ quadrant, patient_ye_and_a209_hyp_clin)
summary_coxfit <- summary(coxfit)


hr <- round(summary_coxfit$coefficients[1, "exp(coef)"], 2)
pval <- format.pval(summary_coxfit$coefficients[1, "Pr(>|z|)"], digits = 2, eps = 0.001)

patient_ye_and_a209_hyp_clin$quadrant <- as.factor(patient_ye_and_a209_hyp_clin$quadrant)

quadrant_levels <- levels(patient_ye_and_a209_hyp_clin$quadrant)


surv_plot <- ggsurvplot(fit_all_hypoxia, data = patient_ye_and_a209_hyp_clin, size = 1, palette = c("#E7B800", "pink", "purple", "#2E9FDF"),legend.labs = quadrant_levels,  break.time.by = 1, ylab="Overall Survival", xlab = "Time in years", xlim = c(0,10),conf.int = TRUE, pval = FALSE, risk.table = FALSE,  risk.table.col = "strata", risk.table.height = 0.25, ggtheme = theme_bw())



surv_plot$plot <- surv_plot$plot + 
  annotate(
    "text", 
    x = 3, y = 0.2, 
    label = paste("HR =", hr, "\np =", pval), 
    size = 5, 
    color = "black"
  )+theme(text = element_text(size = 14))

surv_plot

ggsave("big_changes_surv_plot_a209_hyp_ye.pdf", path=here("plots"),width = 11.5, height=8)









```









# Controls


## Sanity check: positive-ish controls

VITAL_STATUS = living or died of disease


```{r}

# clin2 <- all_data[c(which(all_data$low_signature), which(all_data$high_signature)),]

alive_data <- all_data %>% 
  mutate(alive = ifelse(VITAL_STATUS=="Living", TRUE, FALSE))

alive_data <- alive_data %>% 
  mutate(died_from_cancer = ifelse(VITAL_STATUS=="Died of Disease", TRUE, FALSE))

fit_pos <- survfit(Surv(OS_YEARS, OS_STATUS) ~ died_from_cancer, data = alive_data)


ggsurvplot(fit_pos, data = alive_data, size = 1, palette = c("#E7B800", "#2E9FDF"),legend.labs = c("alive", "died_from_cancer"),  break.time.by = 1, ylab="Overall Survival", xlab = "Time in years", xlim = c(0,10),conf.int = TRUE, pval = TRUE, risk.table = TRUE,  risk.table.col = "strata", risk.table.height = 0.25, ggtheme = theme_bw())



```
Good sanity check! just need to clean up some of the alive vs died data??? maybe?

## Negative Control

Now neg control -- random genes comprising signatures-- same number of genes just random

pos genes = 1747 genes
neg genes = 1638 genes

pick random from all genes expressed in clinical data?? or in my data?


for loop generating z score for each patient



1. Create expression data
```{r}

exp_full <- merged_zscores_matrix %>%
  as.data.frame()

```

2. Pick random up and down values
```{r}

all_genes <- rownames(exp_full)

fake_pos_list <-all_genes[sample(1:length(all_genes), 1747)]
fake_neg_list <-all_genes[sample(1:length(all_genes), 1638)]
```

# fake up signature values - neg ctrl


Loop through each patient
```{r}

patients <- colnames(merged_zscores_all)
patients <- patients[patients !="Hugo_Symbol"]


fake_up_dataset <- data.frame(patient=character(), avg_z_score=numeric(), stringsAsFactors = FALSE)

for (i in patients) {

  #filter dataframe
  patient_level <- exp %>% 
    dplyr::select(i) %>%
    rownames_to_column("Hugo_Symbol") %>% 
    filter(Hugo_Symbol %in% fake_pos_list)

    all_values <- as.vector(patient_level[,2])
  
  
  #geometric mean
  
  up_genes_z_score <- mean(all_values)

  loop_dataset <- data.frame(patient=i, norm_3d_z_score_up = up_genes_z_score)
  
  fake_up_dataset <- rbind(fake_up_dataset, loop_dataset)
}

```





#fake down sig values - neg ctrl

```{r}

patients <- colnames(merged_zscores_all)
patients <- patients[patients !="Hugo_Symbol"]


fake_down_dataset <- data.frame(patient=character(), avg_z_score=numeric(), stringsAsFactors = FALSE)

for (i in patients) {

  #filter dataframe
  patient_level <- exp %>% 
    dplyr::select(i) %>%
    rownames_to_column("Hugo_Symbol") %>% 
    filter(Hugo_Symbol %in% fake_neg_list)

    all_values <- as.vector(patient_level[,2])
  
  
  #geometric mean
  
  down_genes_z_score <- mean(all_values)

  loop_dataset <- data.frame(patient=i, norm_3e_z_score_down = down_genes_z_score)
  
  fake_down_dataset <- rbind(fake_down_dataset, loop_dataset)
}



```


Merge two datasets
```{r}
neg_ctrl_fake_patient_scores <- left_join(fake_up_dataset, fake_down_dataset, by="patient")

neg_ctrl_fake_patient_scores <- neg_ctrl_fake_patient_scores %>% 
  mutate(total_z_score = norm_3e_z_score_up - norm_3e_z_score_down)

```

NEG CONTROL - visualize scores among patient cohort
```{r}
ggplot(neg_ctrl_fake_patient_scores, aes(x=total_z_score))+
  geom_histogram(bins = 400)
```


Stratify into groups based on z score

```{r}

neg_ctrl_quantile_groups <- quantile(neg_ctrl_fake_patient_scores$total_z_score, probs=seq(0,1,.25), na.rm=TRUE)

neg_ctrl_fake_patient_scores$quantile <- cut(neg_ctrl_fake_patient_scores$total_z_score, breaks = quantile_groups, include.lowest = TRUE, labels = FALSE)

neg_ctrl_fake_patient_scores$patient <- gsub("\\.", "-", as.character(neg_ctrl_fake_patient_scores$patient))


colnames(neg_ctrl_fake_patient_scores) <- paste(colnames(neg_ctrl_fake_patient_scores),"neg_ctrl",sep="_") 

names(neg_ctrl_fake_patient_scores)[names(neg_ctrl_fake_patient_scores) == "patient_neg_ctrl"] <- "patient"




```


Now plot neg control!


```{r}
all_data <- left_join(clin, neg_ctrl_fake_patient_scores, by=c("PATIENT_ID"="patient"))


all_data <- all_data %>% 
  mutate(neg_ctrl_high_signature = ifelse(quantile_neg_ctrl==4, TRUE, FALSE))

all_data <- all_data %>% 
  mutate(neg_ctrl_low_signature = ifelse(quantile_neg_ctrl==1, TRUE, FALSE))
```


```{r}
clin2 <- all_data[c(which(all_data$neg_ctrl_low_signature), which(all_data$neg_ctrl_high_signature)),]
fit <- survfit(Surv(OS_YEARS, OS_STATUS) ~ neg_ctrl_low_signature, data = clin2)


ggsurvplot(fit, data = clin2, size = 1, palette = c("#E7B800", "#2E9FDF"),legend.labs = c("NEG CTRL eIF3e KD signature high", "NEG CTRL eIF3e KD signature low"),  break.time.by = 1, ylab="Overall Survival", xlab = "Time in years", xlim = c(0,10),conf.int = TRUE, pval = TRUE, risk.table = TRUE,  risk.table.col = "strata", risk.table.height = 0.25, ggtheme = theme_bw())

```



# Repeat analysis with TCGA dataset

1,108 samples

```{r cache = TRUE}
zscores_tcga <- read.table(here("cbioportal_data/brca_tcga/tcga_data_mrna_seq_v2_rsem_zscores_ref_diploid_samples.txt"), sep="\t", header=T)
row.names(zscores) <- gsub("_", ".",row.names(zscores))

# there are duplicates in this list. What happens when i subset for the genes we are interested in?

zscores_tcga_all_symbol <- zscores_tcga %>% 
  dplyr::select(-Entrez_Gene_Id)

### Average scores for duplicates

merged_tcga_zscores_all <- zscores_tcga_all_symbol %>%
  group_by(Hugo_Symbol) %>%
  summarise(across(everything(), mean))


merged_tcga_zscores_matrix <- merged_tcga_zscores_all %>% 
  column_to_rownames("Hugo_Symbol") %>% 
  as.matrix()


```

Define genes of interest
```{r}
#genes <- sig_3e_hyp$symbol
```



for loop generating z score for each patient

#3e hypoxia

1. Create expression data
```{r}

exp <- merged_tcga_zscores_matrix %>%
  as.data.frame() %>% 
  rownames_to_column("Hugo_Symbol") %>% 
    filter(Hugo_Symbol %in% sig_3e_norm$symbol) %>% 
 column_to_rownames("Hugo_Symbol")


```




#up values


Loop through each patient
```{r}

patients <- colnames(merged_tcga_zscores_all)
patients <- patients[patients !="Hugo_Symbol"]


tcga_up_3e_norm_dataset <- data.frame(patient=character(), avg_z_score=numeric(), stringsAsFactors = FALSE)

for (i in patients) {

  #filter dataframe
  patient_level <- exp %>% 
    dplyr::select(i) %>%
    rownames_to_column("Hugo_Symbol") %>% 
    filter(Hugo_Symbol %in% up_3e_norm$symbol)

    all_values <- as.vector(patient_level[,2])
  
  
  #geometric mean
  
  up_genes_z_score <- mean(all_values, na.rm=TRUE)

  loop_dataset <- data.frame(patient=i, norm_3e_z_score_up = up_genes_z_score)
  
  tcga_up_3e_norm_dataset <- rbind(tcga_up_3e_norm_dataset, loop_dataset)
}

```





#down values

```{r}


tcga_down_3e_norm_dataset <- data.frame(patient=character(), avg_z_score=numeric(), stringsAsFactors = FALSE)

for (i in patients) {

  #filter dataframe
  patient_level <- exp %>% 
    dplyr::select(i) %>%
    rownames_to_column("Hugo_Symbol") %>% 
    filter(Hugo_Symbol %in% down_3e_norm$symbol)

    all_values <- as.vector(patient_level[,2])
  
  
  #geometric mean
  
  down_genes_z_score <- mean(all_values, na.rm=TRUE)

  loop_dataset <- data.frame(patient=i, norm_3e_z_score_down = down_genes_z_score)
  
  tcga_down_3e_norm_dataset <- rbind(tcga_down_3e_norm_dataset, loop_dataset)
}



```


Merge two datasets
```{r}
patient_scores_tcga <- left_join(tcga_up_3e_norm_dataset, tcga_down_3e_norm_dataset, by="patient")

patient_scores_tcga <- patient_scores_tcga %>% 
  mutate(total_z_score = norm_3e_z_score_up - norm_3e_z_score_down)

```

visualize scores among patient cohort
```{r}
ggplot(patient_scores_tcga, aes(x=total_z_score))+
  geom_histogram(bins = 400)
```


Stratify into groups based on z score

```{r}

quantile_groups <- quantile(patient_scores_tcga$total_z_score, probs=seq(0,1,.25), na.rm=TRUE)

patient_scores_tcga$quantile <- cut(patient_scores_tcga$total_z_score, breaks = quantile_groups, include.lowest = TRUE, labels = FALSE)

patient_scores_tcga$patient <- gsub("\\.", "-", as.character(patient_scores_tcga$patient))



```

## Switch to using survival data
Read in and clean up clin data

```{r}
clin_tcga <- read_excel(here("cbioportal_data/new_tcga_clinical.xlsx"))
colnames(clin_tcga)


#modify clin


clin_small <- clin_tcga %>% 
  dplyr::select(OS_STATUS, OS_MONTHS, PATIENT_ID)

# years and months in this are not reading correctly

#get rid of not available

clin_small <- clin_small %>%
  filter(OS_MONTHS != "[Not Available]") %>% 
  filter(OS_MONTHS > 0)

clin_small$OS_MONTHS <- as.numeric(clin_small$OS_MONTHS)

clin_small <- clin_small %>% 
  arrange(OS_MONTHS)


clin_small$OS_STATUS[which(clin_small$OS_STATUS == "1:DECEASED" & clin_small$OS_MONTHS > 120)] <- "0:LIVING"
 
 clin_small$OS_STATUS <- clin_small$OS_STATUS == "1:DECEASED"


clin$OS_MONTHS <- as.numeric(clin$OS_MONTHS)

clin_small <- clin_small %>% 
  mutate(OS_YEARS= clin_small$OS_MONTHS/12)


clin_small$OS_YEARS[which(clin_small$OS_YEARS >= 10)] <- 10



```


Bind clin data with patient z score data
```{r}

patient_scores_tcga$patient <- sub("-01$", "", patient_scores_tcga$patient)
all_data_tcga <- left_join(clin_small, patient_scores_tcga, by=c("PATIENT_ID"="patient"))

```

## eif3e signature vs survival
Visualize survival data by 3e normoxia signature expression

```{r}
fit_all <- survfit(Surv(OS_YEARS, OS_STATUS) ~ quantile, data = all_data_tcga)

coxfit <- coxph(Surv(OS_YEARS, OS_STATUS) ~ quantile, all_data_tcga)
summary(coxfit)

str(survfit(coxfit))

#report hazards ratio on plot

summary_coxfit <- summary(coxfit)

hr <- round(summary_coxfit$coefficients[1, "exp(coef)"], 2)
pval <- format.pval(summary_coxfit$coefficients[1, "Pr(>|z|)"], digits = 2, eps = 0.001)

```

```{r}

surv_plot <- ggsurvplot(fit_all, data = all_data_tcga, size = 1, palette = c("#E7B800", "pink", "purple", "#2E9FDF"),break.time.by = 1, ylab="Overall Survival", xlab = "Time in years", xlim = c(0,10),conf.int = TRUE, pval = FALSE, risk.table = FALSE,  risk.table.col = "strata", risk.table.height = 0.25, ggtheme = theme_bw())



surv_plot$plot <- surv_plot$plot + 
  annotate(
    "text", 
    x = 3, y = 0.2, 
    label = paste("HR =", hr, "\np =", pval), 
    size = 5, 
    color = "black"
  )+
  theme(text = element_text(size = 14))+
  ggtitle("Patient quatiles by eIF3e normoxia signature")

surv_plot

ggsave("3e_normoxia_surv_plot.pdf", path=here("plots"),width = 11.5, height=8)





ggplot(all_data, aes(x=quantile,y=total_z_score, group=quantile)) +
  geom_boxplot()+
  theme_cowplot()+
  ggtitle("Patient scores for eIF3e normoxia signature")

ggsave("3e norm boxplot.pdf",  path=here("plots"), width=4.5, height=4)



```



Repeat in hypoxia 3e


```{r}
# For loop generating z score for each patient

# expression matrix changes based on signature

exp <- merged_tcga_zscores_matrix %>%
  as.data.frame() %>% 
  rownames_to_column("Hugo_Symbol") %>% 
  filter(Hugo_Symbol %in% sig_3e_hyp$symbol) %>% 
  column_to_rownames("Hugo_Symbol")

# up loop

up_3e_hyp_dataset <- data.frame(patient=character(), avg_z_score=numeric(), stringsAsFactors = FALSE)

for (i in patients) {
  
  #filter dataframe
  patient_level <- exp %>% 
    dplyr::select(i) %>%
    rownames_to_column("Hugo_Symbol") %>% 
    filter(Hugo_Symbol %in% up_3e_hyp$symbol)
  
  all_values <- as.vector(patient_level[,2])
  
  
  #geometric mean
  
  up_genes_z_score <- mean(all_values, na.rm=TRUE)
  
  loop_dataset <- data.frame(patient=i, hyp_3e_z_score_up = up_genes_z_score)
  
  up_3e_hyp_dataset <- rbind(up_3e_hyp_dataset, loop_dataset)
}

ggplot(up_3e_hyp_dataset, aes(x=hyp_3e_z_score_up))+
  geom_histogram(bins = 400)


# down loop

down_3e_hyp_dataset <- data.frame(patient=character(), avg_z_score=numeric(), stringsAsFactors = FALSE)

for (i in patients) {
  
  #filter dataframe
  patient_level <- exp %>% 
    dplyr::select(i) %>%
    rownames_to_column("Hugo_Symbol") %>% 
    filter(Hugo_Symbol %in% down_3e_hyp$symbol)
  
  all_values <- as.vector(patient_level[,2])
  
  
  #geometric mean
  
  down_genes_z_score <- mean(all_values, na.rm=TRUE)
  
  loop_dataset <- data.frame(patient=i, hyp_3e_z_score_down = down_genes_z_score)
  
  down_3e_hyp_dataset <- rbind(down_3e_hyp_dataset, loop_dataset)
}

ggplot(down_3e_hyp_dataset, aes(x=hyp_3e_z_score_down))+
  geom_histogram(bins = 400)


# merge datasets

hyp_3e_patient_scores <- left_join(up_3e_hyp_dataset, down_3e_hyp_dataset, by="patient")

hyp_3e_patient_scores <- hyp_3e_patient_scores %>% 
  mutate(total_z_score = hyp_3e_z_score_up - hyp_3e_z_score_down)

#visualize distribution

ggplot(hyp_3e_patient_scores, aes(x=total_z_score))+
  geom_histogram(bins = 400)



### Stratify based on z-score

quantile_groups <- quantile(hyp_3e_patient_scores$total_z_score, probs=seq(0,1,.25), na.rm=TRUE)

hyp_3e_patient_scores$quantile <- cut(hyp_3e_patient_scores$total_z_score, breaks = quantile_groups, include.lowest = TRUE, labels = FALSE)

class(hyp_3e_patient_scores$patient)
class(clin$PATIENT_ID)

hyp_3e_patient_scores$patient %in% clin_small$PATIENT_ID



hyp_3e_patient_scores$patient <- hyp_3e_patient_scores$patient %>%
  sub("\\.01$", "", .) %>%
  gsub("\\.", "-", .)
#bind clin data with z score

hyp_3e_patient_scores$patient %in% clin_small$PATIENT_ID


all_data_3e_hyp <- left_join(clin_small, hyp_3e_patient_scores, by=c("PATIENT_ID"="patient"))


#plot

fit_all_3e_hyp <- survfit(Surv(OS_YEARS, OS_STATUS) ~ quantile, data = all_data_3e_hyp)


coxfit <- coxph(Surv(OS_YEARS, OS_STATUS) ~ quantile, all_data_3e_hyp)
summary_coxfit_3e_norm <- summary(coxfit)


hr <- round(summary_coxfit_3e_norm$coefficients[1, "exp(coef)"], 2)
pval <- format.pval(summary_coxfit_3e_norm$coefficients[1, "Pr(>|z|)"], digits = 2, eps = 0.001)

surv_plot_3e_hyp <- ggsurvplot(fit_all_3e_hyp, data = all_data_3e_hyp, size = 1, palette = c("#E7B800", "pink", "purple", "#2E9FDF"),legend.labs = c("depleted for eIF3e signature (hypoxia): low (Q1)","depleted: medium-low (Q2)", "enriched: medium-high (Q3)", "enriched for eIF3e signature (hypoxia): high (Q4)"),  break.time.by = 1, ylab="Overall Survival", xlab = "Time in years", xlim = c(0,10),conf.int = TRUE, pval = FALSE, risk.table = FALSE,  risk.table.col = NA, risk.table.height = 0.25, ggtheme = theme_bw())

surv_plot_3e_hyp <- ggsurvplot(fit_all_3e_hyp, data = all_data_3e_hyp, size = 1, palette = c("#E7B800", "pink", "purple", "#2E9FDF"),  break.time.by = 1, ylab="Overall Survival", xlab = "Time in years", xlim = c(0,10),conf.int = TRUE, pval = FALSE, risk.table = FALSE,  risk.table.col = NA, risk.table.height = 0.25, ggtheme = theme_bw())



surv_plot_3e_hyp$plot <- surv_plot_3e_hyp$plot + 
  annotate(
    "text", 
    x = 3, y = 0.2, 
    label = paste("HR =", hr, "\np =", pval), 
    size = 5, 
    color = "black"
  )+
  theme(text = element_text(size = 14))+
  ggtitle("Patient quartiles by eIF3e hypoxia signature")

surv_plot_3e_hyp

ggsave("3e_hyp_surv_plot_tcga.pdf", path=here("plots"),width = 11.5, height=8)



#boxplot of quartile expression

ggplot(all_data_3e_hyp, aes(x=quantile,y=total_z_score, group=quantile)) +
  geom_boxplot()+
  theme_cowplot()+
  ggtitle("Patient scores for eIF3e hypoxia signature")

```


## 3d hypoxia

```{r}
# For loop generating z score for each patient

# expression matrix changes based on signature

exp <- merged_tcga_zscores_matrix %>%
  as.data.frame() %>% 
  rownames_to_column("Hugo_Symbol") %>% 
  filter(Hugo_Symbol %in% sig_3d_hyp$symbol) %>% 
  column_to_rownames("Hugo_Symbol")

# up loop

up_3d_hyp_dataset <- data.frame(patient=character(), avg_z_score=numeric(), stringsAsFactors = FALSE)

for (i in patients) {
  
  #filter dataframe
  patient_level <- exp %>% 
    dplyr::select(i) %>%
    rownames_to_column("Hugo_Symbol") %>% 
    filter(Hugo_Symbol %in% up_3d_hyp$symbol)
  
  all_values <- as.vector(patient_level[,2])
  
  
  #geometric mean
  
  up_genes_z_score <- mean(all_values, na.rm=TRUE)
  
  loop_dataset <- data.frame(patient=i, hyp_3d_z_score_up = up_genes_z_score)
  
  up_3d_hyp_dataset <- rbind(up_3d_hyp_dataset, loop_dataset)
}

ggplot(up_3d_hyp_dataset, aes(x=hyp_3d_z_score_up))+
  geom_histogram(bins = 400)


# down loop

down_3d_hyp_dataset <- data.frame(patient=character(), avg_z_score=numeric(), stringsAsFactors = FALSE)

for (i in patients) {
  
  #filter dataframe
  patient_level <- exp %>% 
    dplyr::select(i) %>%
    rownames_to_column("Hugo_Symbol") %>% 
    filter(Hugo_Symbol %in% down_3d_hyp$symbol)
  
  all_values <- as.vector(patient_level[,2])
  
  
  #geometric mean
  
  down_genes_z_score <- mean(all_values, na.rm=TRUE)
  
  loop_dataset <- data.frame(patient=i, hyp_3d_z_score_down = down_genes_z_score)
  
  down_3d_hyp_dataset <- rbind(down_3d_hyp_dataset, loop_dataset)
}

ggplot(down_3d_hyp_dataset, aes(x=hyp_3d_z_score_down))+
  geom_histogram(bins = 400)


# merge datasets

hyp_3d_patient_scores <- left_join(up_3d_hyp_dataset, down_3d_hyp_dataset, by="patient")

hyp_3d_patient_scores <- hyp_3d_patient_scores %>% 
  mutate(total_z_score = hyp_3d_z_score_up - hyp_3d_z_score_down)

#visualize distribution

ggplot(hyp_3d_patient_scores, aes(x=total_z_score))+
  geom_histogram(bins = 400)



### Stratify based on z-score

quantile_groups <- quantile(hyp_3d_patient_scores$total_z_score, probs=seq(0,1,.25), na.rm=TRUE)

hyp_3d_patient_scores$quantile <- cut(hyp_3d_patient_scores$total_z_score, breaks = quantile_groups, include.lowest = TRUE, labels = FALSE)

class(hyp_3d_patient_scores$patient)
class(clin$PATIENT_ID)

hyp_3d_patient_scores$patient %in% clin_small$PATIENT_ID



hyp_3d_patient_scores$patient <- hyp_3d_patient_scores$patient %>%
  sub("\\.01$", "", .) %>%
  gsub("\\.", "-", .)
#bind clin data with z score

hyp_3d_patient_scores$patient %in% clin_small$PATIENT_ID


all_data_3d_hyp <- left_join(clin_small, hyp_3d_patient_scores, by=c("PATIENT_ID"="patient"))


#plot

fit_all_3d_hyp <- survfit(Surv(OS_YEARS, OS_STATUS) ~ quantile, data = all_data_3d_hyp)


coxfit <- coxph(Surv(OS_YEARS, OS_STATUS) ~ quantile, all_data_3d_hyp)
summary_coxfit_3d_norm <- summary(coxfit)


hr <- round(summary_coxfit_3d_norm$coefficients[1, "exp(coef)"], 2)
pval <- format.pval(summary_coxfit_3d_norm$coefficients[1, "Pr(>|z|)"], digits = 2, eps = 0.001)

surv_plot_3d_hyp <- ggsurvplot(fit_all_3d_hyp, data = all_data_3d_hyp, size = 1, palette = c("#E7B800", "pink", "purple", "#2E9FDF"),legend.labs = c("depleted for eIF3d signature (hypoxia): low (Q1)","depleted: medium-low (Q2)", "enriched: medium-high (Q3)", "enriched for eIF3d signature (hypoxia): high (Q4)"),  break.time.by = 1, ylab="Overall Survival", xlab = "Time in years", xlim = c(0,10),conf.int = TRUE, pval = FALSE, risk.table = FALSE,  risk.table.col = NA, risk.table.height = 0.25, ggtheme = theme_bw())

surv_plot_3d_hyp <- ggsurvplot(fit_all_3d_hyp, data = all_data_3d_hyp, size = 1, palette = c("#E7B800", "pink", "purple", "#2E9FDF"),  break.time.by = 1, ylab="Overall Survival", xlab = "Time in years", xlim = c(0,10),conf.int = TRUE, pval = FALSE, risk.table = FALSE,  risk.table.col = NA, risk.table.height = 0.25, ggtheme = theme_bw())



surv_plot_3d_hyp$plot <- surv_plot_3d_hyp$plot + 
  annotate(
    "text", 
    x = 3, y = 0.2, 
    label = paste("HR =", hr, "\np =", pval), 
    size = 5, 
    color = "black"
  )+
  theme(text = element_text(size = 14))+
  ggtitle("Patient quartiles by eIF3d hypoxia signature")

surv_plot_3d_hyp

ggsave("3d_hyp_surv_plot_tcga.pdf", path=here("plots"),width = 11.5, height=8)



#boxplot of quartile expression

ggplot(all_data_3d_hyp, aes(x=quantile,y=total_z_score, group=quantile)) +
  geom_boxplot()+
  theme_cowplot()+
  ggtitle("Patient scores for eIF3d hypoxia signature")

```


## 3d normoxia

```{r}
# For loop generating z score for each patient

# expression matrix changes based on signature

exp <- merged_tcga_zscores_matrix %>%
  as.data.frame() %>% 
  rownames_to_column("Hugo_Symbol") %>% 
  filter(Hugo_Symbol %in% sig_3d_norm$symbol) %>% 
  column_to_rownames("Hugo_Symbol")

# up loop

up_3d_norm_dataset <- data.frame(patient=character(), avg_z_score=numeric(), stringsAsFactors = FALSE)

for (i in patients) {
  
  #filter dataframe
  patient_level <- exp %>% 
    dplyr::select(i) %>%
    rownames_to_column("Hugo_Symbol") %>% 
    filter(Hugo_Symbol %in% up_3d_norm$symbol)
  
  all_values <- as.vector(patient_level[,2])
  
  
  #geometric mean
  
  up_genes_z_score <- mean(all_values, na.rm=TRUE)
  
  loop_dataset <- data.frame(patient=i, norm_3d_z_score_up = up_genes_z_score)
  
  up_3d_norm_dataset <- rbind(up_3d_norm_dataset, loop_dataset)
}

ggplot(up_3d_norm_dataset, aes(x=norm_3d_z_score_up))+
  geom_histogram(bins = 400)


# down loop

down_3d_norm_dataset <- data.frame(patient=character(), avg_z_score=numeric(), stringsAsFactors = FALSE)

for (i in patients) {
  
  #filter dataframe
  patient_level <- exp %>% 
    dplyr::select(i) %>%
    rownames_to_column("Hugo_Symbol") %>% 
    filter(Hugo_Symbol %in% down_3d_norm$symbol)
  
  all_values <- as.vector(patient_level[,2])
  
  
  #geometric mean
  
  down_genes_z_score <- mean(all_values, na.rm=TRUE)
  
  loop_dataset <- data.frame(patient=i, norm_3d_z_score_down = down_genes_z_score)
  
  down_3d_norm_dataset <- rbind(down_3d_norm_dataset, loop_dataset)
}

ggplot(down_3d_norm_dataset, aes(x=norm_3d_z_score_down))+
  geom_histogram(bins = 400)


# merge datasets

norm_3d_patient_scores <- left_join(up_3d_norm_dataset, down_3d_norm_dataset, by="patient")

norm_3d_patient_scores <- norm_3d_patient_scores %>% 
  mutate(total_z_score = norm_3d_z_score_up - norm_3d_z_score_down)

#visualize distribution

ggplot(norm_3d_patient_scores, aes(x=total_z_score))+
  geom_histogram(bins = 400)



### Stratify based on z-score

quantile_groups <- quantile(norm_3d_patient_scores$total_z_score, probs=seq(0,1,.25), na.rm=TRUE)

norm_3d_patient_scores$quantile <- cut(norm_3d_patient_scores$total_z_score, breaks = quantile_groups, include.lowest = TRUE, labels = FALSE)

class(norm_3d_patient_scores$patient)
class(clin$PATIENT_ID)

norm_3d_patient_scores$patient %in% clin_small$PATIENT_ID



norm_3d_patient_scores$patient <- norm_3d_patient_scores$patient %>%
  sub("\\.01$", "", .) %>%
  gsub("\\.", "-", .)
#bind clin data with z score

norm_3d_patient_scores$patient %in% clin_small$PATIENT_ID


all_data_3d_norm <- left_join(clin_small, norm_3d_patient_scores, by=c("PATIENT_ID"="patient"))


#plot

fit_all_3d_norm <- survfit(Surv(OS_YEARS, OS_STATUS) ~ quantile, data = all_data_3d_norm)


coxfit <- coxph(Surv(OS_YEARS, OS_STATUS) ~ quantile, all_data_3d_norm)
summary_coxfit_3d_norm <- summary(coxfit)


hr <- round(summary_coxfit_3d_norm$coefficients[1, "exp(coef)"], 2)
pval <- format.pval(summary_coxfit_3d_norm$coefficients[1, "Pr(>|z|)"], digits = 2, eps = 0.001)

surv_plot_3d_norm <- ggsurvplot(fit_all_3d_norm, data = all_data_3d_norm, size = 1, palette = c("#E7B800", "pink", "purple", "#2E9FDF"),legend.labs = c("depleted for eIF3d signature (normoxia): low (Q1)","depleted: medium-low (Q2)", "enriched: medium-high (Q3)", "enriched for eIF3d signature (normoxia): high (Q4)"),  break.time.by = 1, ylab="Overall Survival", xlab = "Time in years", xlim = c(0,10),conf.int = TRUE, pval = FALSE, risk.table = FALSE,  risk.table.col = NA, risk.table.height = 0.25, ggtheme = theme_bw())

surv_plot_3d_norm <- ggsurvplot(fit_all_3d_norm, data = all_data_3d_norm, size = 1, palette = c("#E7B800", "pink", "purple", "#2E9FDF"),  break.time.by = 1, ylab="Overall Survival", xlab = "Time in years", xlim = c(0,10),conf.int = TRUE, pval = FALSE, risk.table = FALSE,  risk.table.col = NA, risk.table.height = 0.25, ggtheme = theme_bw())



surv_plot_3d_norm$plot <- surv_plot_3d_norm$plot + 
  annotate(
    "text", 
    x = 3, y = 0.2, 
    label = paste("HR =", hr, "\np =", pval), 
    size = 5, 
    color = "black"
  )+
  theme(text = element_text(size = 14))+
  ggtitle("Patient quartiles by eIF3d normoxia signature")

surv_plot_3d_norm

ggsave("3d_norm_surv_plot_tcga.pdf", path=here("plots"),width = 11.5, height=8)



#boxplot of quartile expression

ggplot(all_data_3d_norm, aes(x=quantile,y=total_z_score, group=quantile)) +
  geom_boxplot()+
  theme_cowplot()+
  ggtitle("Patient scores for eIF3d normoxia signature")

```








## Sanity check: positive-ish controls

VITAL_STATUS = living or died of disease


```{r}

clin2 <- all_data[c(which(all_data$low_signature), which(all_data$high_signature)),]

all_data <- all_data %>% 
  mutate(alive = ifelse(VITAL_STATUS=="Living", TRUE, FALSE))

all_data <- all_data %>% 
  mutate(died_from_cancer = ifelse(VITAL_STATUS=="Died of Disease", TRUE, FALSE))

fit_pos <- survfit(Surv(OS_YEARS, OS_STATUS) ~ died_from_cancer, data = clin2)


ggsurvplot(fit_pos, data = clin2, size = 1, palette = c("#E7B800", "#2E9FDF"),legend.labs = c("alive", "died_from_cancer"),  break.time.by = 1, ylab="Overall Survival", xlab = "Time in years", xlim = c(0,10),conf.int = TRUE, pval = TRUE, risk.table = TRUE,  risk.table.col = "strata", risk.table.height = 0.25, ggtheme = theme_bw())



```
Good sanity check! just need to clean up some of the alive vs died data??? maybe?

## Negative Control

Now neg control -- random genes comprising signatures-- same number of genes just random

pos genes = 1747 genes
neg genes = 1638 genes

pick random from all genes expressed in clinical data?? or in my data?


for loop generating z score for each patient



1. Create expression data
```{r}

exp_full <- merged_zscores_matrix %>%
  as.data.frame()

```

2. Pick random up and down values
```{r}

all_genes <- rownames(exp_full)

fake_pos_list <-all_genes[sample(1:length(all_genes), 1747)]
fake_neg_list <-all_genes[sample(1:length(all_genes), 1638)]
```

# fake up signature values - neg ctrl


Loop through each patient
```{r}

patients <- colnames(merged_zscores_all)
patients <- patients[patients !="Hugo_Symbol"]


fake_up_dataset <- data.frame(patient=character(), avg_z_score=numeric(), stringsAsFactors = FALSE)

for (i in patients) {

  #filter dataframe
  patient_level <- exp %>% 
    dplyr::select(i) %>%
    rownames_to_column("Hugo_Symbol") %>% 
    filter(Hugo_Symbol %in% fake_pos_list)

    all_values <- as.vector(patient_level[,2])
  
  
  #geometric mean
  
  up_genes_z_score <- mean(all_values)

  loop_dataset <- data.frame(patient=i, norm_3e_z_score_up = up_genes_z_score)
  
  fake_up_dataset <- rbind(fake_up_dataset, loop_dataset)
}

```





#fake down sig values - neg ctrl

```{r}

patients <- colnames(merged_zscores_all)
patients <- patients[patients !="Hugo_Symbol"]


fake_down_dataset <- data.frame(patient=character(), avg_z_score=numeric(), stringsAsFactors = FALSE)

for (i in patients) {

  #filter dataframe
  patient_level <- exp %>% 
    dplyr::select(i) %>%
    rownames_to_column("Hugo_Symbol") %>% 
    filter(Hugo_Symbol %in% fake_neg_list)

    all_values <- as.vector(patient_level[,2])
  
  
  #geometric mean
  
  down_genes_z_score <- mean(all_values)

  loop_dataset <- data.frame(patient=i, norm_3e_z_score_down = down_genes_z_score)
  
  fake_down_dataset <- rbind(fake_down_dataset, loop_dataset)
}



```


Merge two datasets
```{r}
neg_ctrl_fake_patient_scores <- left_join(fake_up_dataset, fake_down_dataset, by="patient")

neg_ctrl_fake_patient_scores <- neg_ctrl_fake_patient_scores %>% 
  mutate(total_z_score = norm_3e_z_score_up - norm_3e_z_score_down)

```

NEG CONTROL - visualize scores among patient cohort
```{r}
ggplot(neg_ctrl_fake_patient_scores, aes(x=total_z_score))+
  geom_histogram(bins = 400)
```


Stratify into groups based on z score

```{r}

neg_ctrl_quantile_groups <- quantile(neg_ctrl_fake_patient_scores$total_z_score, probs=seq(0,1,.25), na.rm=TRUE)

neg_ctrl_fake_patient_scores$quantile <- cut(neg_ctrl_fake_patient_scores$total_z_score, breaks = quantile_groups, include.lowest = TRUE, labels = FALSE)

neg_ctrl_fake_patient_scores$patient <- gsub("\\.", "-", as.character(neg_ctrl_fake_patient_scores$patient))


colnames(neg_ctrl_fake_patient_scores) <- paste(colnames(neg_ctrl_fake_patient_scores),"neg_ctrl",sep="_") 

names(neg_ctrl_fake_patient_scores)[names(neg_ctrl_fake_patient_scores) == "patient_neg_ctrl"] <- "patient"




```


Now plot neg control!


```{r}
all_data <- left_join(clin, neg_ctrl_fake_patient_scores, by=c("PATIENT_ID"="patient"))


all_data <- all_data %>% 
  mutate(neg_ctrl_high_signature = ifelse(quantile_neg_ctrl==4, TRUE, FALSE))

all_data <- all_data %>% 
  mutate(neg_ctrl_low_signature = ifelse(quantile_neg_ctrl==1, TRUE, FALSE))
```


```{r}
clin2 <- all_data[c(which(all_data$neg_ctrl_low_signature), which(all_data$neg_ctrl_high_signature)),]
fit <- survfit(Surv(OS_YEARS, OS_STATUS) ~ neg_ctrl_low_signature, data = clin2)


ggsurvplot(fit, data = clin2, size = 1, palette = c("#E7B800", "#2E9FDF"),legend.labs = c("NEG CTRL eIF3e KD signature high", "NEG CTRL eIF3e KD signature low"),  break.time.by = 1, ylab="Overall Survival", xlab = "Time in years", xlim = c(0,10),conf.int = TRUE, pval = TRUE, risk.table = TRUE,  risk.table.col = "strata", risk.table.height = 0.25, ggtheme = theme_bw())

```



