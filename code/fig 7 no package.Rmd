---
title: "fig 7 no package"
author: "Kate"
date: "2024-08-01"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


load packages
```{r}
library(here)
library(tidyverse)
library(janitor)
library(readxl)
#BiocManager::install("cBioPortalData")
library(cBioPortalData)
library(MetaIntegrator)
#BiocManager::install("singleCellTK")
#library(singleCellTK)
library(cbioportalR)
library(pheatmap)
library(cowplot)
library(ggpubr)
library(survival)
library(survminer)
library(GSVA)
library(GSEABase)
library(matrixStats)
```

# My data
load signatures from my data
```{r}
file_path <- here("counts/rna_values_sig.xlsx")

sheet_names <- excel_sheets(file_path)

all_sheets <- lapply(sheet_names, function(sheet) {
  read_excel(file_path, sheet = sheet)
})

names(all_sheets) <- sheet_names

```

all_sheets now has all four signatures from our data

```{r}
sig_3d_norm <-all_sheets$normoxia_si3d
sig_3e_norm <-all_sheets$normoxia_si3e
sig_3d_hyp <-all_sheets$hypoxia_si3d
sig_3e_hyp <-all_sheets$hypoxia_si3e
```

### Beginning with Normoxia 3e

separate direction
```{r}
up_3e_norm <- sig_3e_norm %>% 
  filter(log2FoldChange > 0)

down_3e_norm <- sig_3e_norm %>% 
  filter(log2FoldChange < 0)
```


Now, use up and down to make cumulative scores


# Metabric data - read in z scores and matching clinical data
```{r}
zscores <- read.table(here("cbioportal_data/data_mrna_illumina_microarray_zscores_ref_diploid_samples.txt"), sep="\t", header=T)
row.names(zscores) <- gsub("_", ".",row.names(zscores))

# there are duplicates in this list. What happens when i subset for the genes we are interested in?

zscores_all_symbol <- zscores %>% 
  dplyr::select(-Entrez_Gene_Id)

### Average scores for duplicates

merged_zscores_all <- zscores_all_symbol %>%
  group_by(Hugo_Symbol) %>%
  summarise(across(everything(), mean))


merged_zscores_matrix <- merged_zscores_all %>% 
  column_to_rownames("Hugo_Symbol") %>% 
  as.matrix()


```

Define genes of interest
```{r}
genes <- sig_3e_norm$symbol
```



```{r}

verified_genes <- genes[genes %in% rownames(merged_zscores_matrix)]

filtered_expr <- merged_zscores_matrix[verified_genes, , drop = FALSE]


```



for loop generating z score for each patient



1. Create expression data
```{r}

exp <- merged_zscores_matrix %>%
  as.data.frame() %>% 
  rownames_to_column("Hugo_Symbol") %>% 
    filter(Hugo_Symbol %in% sig_3e_norm$symbol) %>% 
 column_to_rownames("Hugo_Symbol")


```




#up values


Loop through each patient
```{r}

patients <- colnames(merged_zscores_all)
patients <- patients[patients !="Hugo_Symbol"]


up_3e_norm_dataset <- data.frame(patient=character(), avg_z_score=numeric(), stringsAsFactors = FALSE)

for (i in patients) {

  #filter dataframe
  patient_level <- exp %>% 
    dplyr::select(i) %>%
    rownames_to_column("Hugo_Symbol") %>% 
    filter(Hugo_Symbol %in% up_3e_norm$symbol)

    all_values <- as.vector(patient_level[,2])
  
  
  #geometric mean
  
  up_genes_z_score <- mean(all_values)

  loop_dataset <- data.frame(patient=i, norm_3e_z_score_up = up_genes_z_score)
  
  up_3e_norm_dataset <- rbind(up_3e_norm_dataset, loop_dataset)
}

```





#down values

```{r}

patients <- colnames(merged_zscores_all)
patients <- patients[patients !="Hugo_Symbol"]


down_3e_norm_dataset <- data.frame(patient=character(), avg_z_score=numeric(), stringsAsFactors = FALSE)

for (i in patients) {

  #filter dataframe
  patient_level <- exp %>% 
    dplyr::select(i) %>%
    rownames_to_column("Hugo_Symbol") %>% 
    filter(Hugo_Symbol %in% down_3e_norm$symbol)

    all_values <- as.vector(patient_level[,2])
  
  
  #geometric mean
  
  down_genes_z_score <- mean(all_values)

  loop_dataset <- data.frame(patient=i, norm_3e_z_score_down = down_genes_z_score)
  
  down_3e_norm_dataset <- rbind(down_3e_norm_dataset, loop_dataset)
}



```


Merge two datasets
```{r}
patient_scores <- left_join(up_3e_norm_dataset, down_3e_norm_dataset, by="patient")

patient_scores <- patient_scores %>% 
  mutate(total_z_score = norm_3e_z_score_up - norm_3e_z_score_down)

```

visualize scores among patient cohort
```{r}
ggplot(patient_scores, aes(x=total_z_score))+
  geom_histogram(bins = 400)
```


Stratify into groups based on z score

```{r}

quantile_groups <- quantile(patient_scores$total_z_score, probs=seq(0,1,.25), na.rm=TRUE)

patient_scores$quantile <- cut(patient_scores$total_z_score, breaks = quantile_groups, include.lowest = TRUE, labels = FALSE)

patient_scores$patient <- gsub("\\.", "-", as.character(patient_scores$patient))



```





## Switch to using survival data
Read in and clean up clin data
  
```{r}

clin <- read.table(here("cbioportal_data/data_clinical_patient.txt"), sep="\t", header=T)


clin$OS_STATUS[which(clin$OS_STATUS == "1:DECEASED" & clin$OS_MONTHS > 120)] <- "0:LIVING"
clin$OS_STATUS <- clin$OS_STATUS == "1:DECEASED"
clin <- cbind(clin, OS_YEARS = clin$OS_MONTHS/12)
clin$OS_YEARS[which(clin$OS_YEARS >= 10)] <- 10
dim(clin)


```


Bind clin data with z scores

```{r}
all_data <- left_join(clin, patient_scores, by=c("PATIENT_ID"="patient"))


all_data <- all_data %>% 
  mutate(high_signature = ifelse(quantile==4, TRUE, FALSE))

all_data <- all_data %>% 
  mutate(low_signature = ifelse(quantile==1, TRUE, FALSE))
```



Stratifying survival data
## eif3e signature vs survival

```{r}
clin2 <- all_data[c(which(all_data$low_signature), which(all_data$high_signature)),]
fit <- survfit(Surv(OS_YEARS, OS_STATUS) ~ low_signature, data = clin2)


ggsurvplot(fit, data = clin2, size = 1, palette = c("#E7B800", "#2E9FDF"),legend.labs = c("eIF3e KD signature high", "eIF3e KD signature low"),  break.time.by = 1, ylab="Overall Survival", xlab = "Time in years", xlim = c(0,10),conf.int = TRUE, pval = TRUE, risk.table = TRUE,  risk.table.col = "strata", risk.table.height = 0.25, ggtheme = theme_bw())

```

## Sanity check: positive-ish controls

Compare lymph nodes positive to suvival-- prob should have more lymph notes positive = less survival

VITAL_STATUS = living or died of disease


```{r}

clin2 <- all_data[c(which(all_data$low_signature), which(all_data$high_signature)),]

all_data <- all_data %>% 
  mutate(alive = ifelse(VITAL_STATUS=="Living", TRUE, FALSE))

all_data <- all_data %>% 
  mutate(died_from_cancer = ifelse(VITAL_STATUS=="Died of Disease", TRUE, FALSE))

fit_pos <- survfit(Surv(OS_YEARS, OS_STATUS) ~ died_from_cancer, data = clin2)


ggsurvplot(fit_pos, data = clin2, size = 1, palette = c("#E7B800", "#2E9FDF"),legend.labs = c("alive", "died_from_cancer"),  break.time.by = 1, ylab="Overall Survival", xlab = "Time in years", xlim = c(0,10),conf.int = TRUE, pval = TRUE, risk.table = TRUE,  risk.table.col = "strata", risk.table.height = 0.25, ggtheme = theme_bw())



```
Good sanity check! just need to clean up some of the alive vs died data

## Negative Control

Now neg control -- random genes comprising signatures-- same number of genes just random

pos genes = 1747 genes
neg genes = 1638 genes

pick random from all genes expressed in clinical data?? or in my data?


for loop generating z score for each patient



1. Create expression data
```{r}

exp_full <- merged_zscores_matrix %>%
  as.data.frame()

```

2. Pick random up and down values
```{r}

all_genes <- rownames(exp_full)

fake_pos_list <-all_genes[sample(1:length(all_genes), 1747)]
fake_neg_list <-all_genes[sample(1:length(all_genes), 1638)]
```

# fake up signature values - neg ctrl


Loop through each patient
```{r}

patients <- colnames(merged_zscores_all)
patients <- patients[patients !="Hugo_Symbol"]


fake_up_dataset <- data.frame(patient=character(), avg_z_score=numeric(), stringsAsFactors = FALSE)

for (i in patients) {

  #filter dataframe
  patient_level <- exp %>% 
    dplyr::select(i) %>%
    rownames_to_column("Hugo_Symbol") %>% 
    filter(Hugo_Symbol %in% fake_pos_list)

    all_values <- as.vector(patient_level[,2])
  
  
  #geometric mean
  
  up_genes_z_score <- mean(all_values)

  loop_dataset <- data.frame(patient=i, norm_3e_z_score_up = up_genes_z_score)
  
  fake_up_dataset <- rbind(fake_up_dataset, loop_dataset)
}

```





#fake down sig values - neg ctrl

```{r}

patients <- colnames(merged_zscores_all)
patients <- patients[patients !="Hugo_Symbol"]


fake_down_dataset <- data.frame(patient=character(), avg_z_score=numeric(), stringsAsFactors = FALSE)

for (i in patients) {

  #filter dataframe
  patient_level <- exp %>% 
    dplyr::select(i) %>%
    rownames_to_column("Hugo_Symbol") %>% 
    filter(Hugo_Symbol %in% fake_neg_list)

    all_values <- as.vector(patient_level[,2])
  
  
  #geometric mean
  
  down_genes_z_score <- mean(all_values)

  loop_dataset <- data.frame(patient=i, norm_3e_z_score_down = down_genes_z_score)
  
  fake_down_dataset <- rbind(fake_down_dataset, loop_dataset)
}



```


Merge two datasets
```{r}
neg_ctrl_fake_patient_scores <- left_join(fake_up_dataset, fake_down_dataset, by="patient")

neg_ctrl_fake_patient_scores <- neg_ctrl_fake_patient_scores %>% 
  mutate(total_z_score = norm_3e_z_score_up - norm_3e_z_score_down)

```

NEG CONTROL - visualize scores among patient cohort
```{r}
ggplot(neg_ctrl_fake_patient_scores, aes(x=total_z_score))+
  geom_histogram(bins = 400)
```


Stratify into groups based on z score

```{r}

neg_ctrl_quantile_groups <- quantile(neg_ctrl_fake_patient_scores$total_z_score, probs=seq(0,1,.25), na.rm=TRUE)

neg_ctrl_fake_patient_scores$quantile <- cut(neg_ctrl_fake_patient_scores$total_z_score, breaks = quantile_groups, include.lowest = TRUE, labels = FALSE)

neg_ctrl_fake_patient_scores$patient <- gsub("\\.", "-", as.character(neg_ctrl_fake_patient_scores$patient))


colnames(neg_ctrl_fake_patient_scores) <- paste(colnames(neg_ctrl_fake_patient_scores),"neg_ctrl",sep="_") 

names(neg_ctrl_fake_patient_scores)[names(neg_ctrl_fake_patient_scores) == "patient_neg_ctrl"] <- "patient"




```


Now plot neg control!


```{r}
all_data <- left_join(clin, neg_ctrl_fake_patient_scores, by=c("PATIENT_ID"="patient"))


all_data <- all_data %>% 
  mutate(neg_ctrl_high_signature = ifelse(quantile_neg_ctrl==4, TRUE, FALSE))

all_data <- all_data %>% 
  mutate(neg_ctrl_low_signature = ifelse(quantile_neg_ctrl==1, TRUE, FALSE))
```



Stratifying survival data
## eif3e signature vs survival

```{r}
clin2 <- all_data[c(which(all_data$neg_ctrl_low_signature), which(all_data$neg_ctrl_high_signature)),]
fit <- survfit(Surv(OS_YEARS, OS_STATUS) ~ neg_ctrl_low_signature, data = clin2)


ggsurvplot(fit, data = clin2, size = 1, palette = c("#E7B800", "#2E9FDF"),legend.labs = c("NEG CTRL eIF3e KD signature high", "NEG CTRL eIF3e KD signature low"),  break.time.by = 1, ylab="Overall Survival", xlab = "Time in years", xlim = c(0,10),conf.int = TRUE, pval = TRUE, risk.table = TRUE,  risk.table.col = "strata", risk.table.height = 0.25, ggtheme = theme_bw())

```









































```{r}

clin2 <- all_data[c(which(all_data$low_signature), which(all_data$high_signature)),]
fit <- survfit(Surv(OS_YEARS, OS_STATUS) ~ low_signature, data = clin2)


ggsurvplot(fit, data = clin2, size = 1, palette = c("#E7B800", "#2E9FDF"),legend.labs = c("eIF3e KD signature high", "eIF3e KD signature low"),  break.time.by = 1, ylab="Overall Survival", xlab = "Time in years", xlim = c(0,10),conf.int = TRUE, pval = TRUE, risk.table = TRUE,  risk.table.col = "strata", risk.table.height = 0.25, ggtheme = theme_bw())


```




















```{r}

clin2 <- clin[c(which(clin$NFKBlowq), which(clin$NFKBupperq)),]
fit <- survfit(Surv(OS_YEARS, OS_STATUS) ~ NFKBlowq, data = clin2)

ggsurvplot(fit, data = clin2, size = 1, palette = c("#E7B800", "#2E9FDF"),legend.labs = c("NFKB high", "NFKB low"),  break.time.by = 1, ylab="Overall Survival", xlab = "Time in years", xlim = c(0,10),conf.int = TRUE, pval = TRUE, risk.table = TRUE,  risk.table.col = "strata", risk.table.height = 0.25, ggtheme = theme_bw())

```




Stratifying survival using Jim's code - surv

```{r}
#quartile stratification


clin2 <- clin[c(which(clin$NFKBlowq), which(clin$NFKBupperq)),]
fit <- survfit(Surv(OS_YEARS, OS_STATUS) ~ NFKBlowq, data = clin2)

ggsurvplot(fit, data = clin2, size = 1, palette = c("#E7B800", "#2E9FDF"),legend.labs = c("NFKB high", "NFKB low"),  break.time.by = 1, ylab="Overall Survival", xlab = "Time in years", xlim = c(0,10),conf.int = TRUE, pval = TRUE, risk.table = TRUE,  risk.table.col = "strata", risk.table.height = 0.25, ggtheme = theme_bw())

clin2 <- clin[c(which(clin$EYA3lowq), which(clin$EYA3upperq)),]
fit <- survfit(Surv(OS_YEARS, OS_STATUS) ~ EYA3lowq, data = clin2)
ggsurvplot(fit, data = clin2, size = 1, palette = c("#E7B800", "#2E9FDF"),legend.labs = c("EYA3 high", "EYA3 low"),  break.time.by = 1, ylab="Overall Survival", xlab = "Time in years", xlim = c(0,10),conf.int = TRUE, pval = TRUE, risk.table = TRUE,  risk.table.col = "strata", risk.table.height = 0.25, ggtheme = theme_bw())

clin2 <- clin[c(which(clin$CCL2lowq), which(clin$CCL2upperq)),]
fit <- survfit(Surv(OS_YEARS, OS_STATUS) ~ CCL2lowq, data = clin2)
ggsurvplot(fit, data = clin2, size = 1, palette = c("#E7B800", "#2E9FDF"),legend.labs = c("CCL2 high", "CCL2 low"), break.time.by = 1, ylab="Overall Survival", xlab = "Time in years", xlim = c(0,10), conf.int = TRUE, pval = TRUE, risk.table = TRUE,  risk.table.col = "strata", risk.table.height = 0.25, ggtheme = theme_bw())

clin2 <- clin[which(clin$HighLowq > 0),]
fit <- survfit(Surv(OS_YEARS, OS_STATUS) ~ HighLowq, data = clin2)
ggsurvplot(fit, data = clin2, size = 1, legend.labs = c("EYA3 high/CCL2 high", "EYA3 high/CCL2 low", "EYA3 low/CCL2 high", "EYA3 low/CCL2 low"), ylab="Overall Survival", xlab = "Time in years", xlim = c(0,10), conf.int = TRUE, pval = TRUE, risk.table = TRUE,  risk.table.col = "strata", risk.table.height = 0.25, ggtheme = theme_bw())

clin2 <- clin[which(clin$HighLowNFKBq > 0),]
fit <- survfit(Surv(OS_YEARS, OS_STATUS) ~ HighLowNFKBq, data = clin2)
ggsurvplot(fit, data = clin2, size = 1, legend.labs = c("EYA3 high/NFKB high", "EYA3 high/NFKB low", "EYA3 low/NFKB high", "EYA3 low/NFKB low"), ylab="Overall Survival", xlab = "Time in years", xlim = c(0,10), conf.int = TRUE, pval = TRUE, risk.table = TRUE,  risk.table.col = "strata", risk.table.height = 0.25, ggtheme = theme_bw())

clin2 <- clin[which(clin$HighLowTrippleq > 0),]
fit <- survfit(Surv(OS_YEARS, OS_STATUS) ~ HighLowTrippleq, data = clin2)
ggsurvplot(fit, data = clin2, size = 1, palette = c("#E7B800", "#2E9FDF"),legend.labs = c("Tripple high", "Tripple low"), ylab="Overall Survival", xlab = "Time in years", break.time.by = 1,  xlim = c(0,10), conf.int = TRUE, pval = TRUE, risk.table = TRUE,  risk.table.col = "strata", risk.table.height = 0.25, ggtheme = theme_bw())

```

